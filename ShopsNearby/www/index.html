<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <title>脸脸</title> 

    <link rel="stylesheet"  href="css/themes/default/jquery.mobile.css" />  
    <link rel="stylesheet"  href="css/scrollpagination_demo.css" />  
    <link rel="stylesheet" href="_assets/css/jqm-docs.css"/>

    <script src="js/jquery.js"></script>
    <script src="_assets/js/jqm-docs.js"></script>
    <script src="js/jquery.mobile.docs.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/scrollpagination.js"></script>

    <script type="text/javascript" charset="utf-8" src="cordova-1.5.0.js"></script>
    <script type="text/javascript" charset="utf-8" src="y1y.js"></script>

    <script type="text/javascript">
      //  http://www.1dooo.com/mshop/aroundme?lat=30.2829754&lng=120.1337336
    var shops = [{"mshop":{"name":"天方专业美容(文二路店)","address":"文二路169号","created_at":"2012-03-07T00:16:48+08:00","linkman":"","updated_at":"2012-03-07T00:33:58+08:00","dp_id":4152730,"mcity_id":3,"fullname":"","lng":120.13841,"kb_id":"","id":47258,"phone":"","lat":30.28177}},{"mshop":{"name":"情侣礼品专卖","address":"文二路147号","created_at":"2012-03-06T17:57:53+08:00","linkman":"","updated_at":"2012-03-06T18:46:49+08:00","dp_id":1604632,"mcity_id":3,"fullname":"","lng":120.13913,"kb_id":"","id":35125,"phone":"85619810","lat":30.28192}},{"mshop":{"name":"保俶花园","address":"保俶北路57号","created_at":"2012-03-07T03:18:59+08:00","linkman":"","updated_at":"2012-03-07T03:44:55+08:00","dp_id":5207487,"mcity_id":3,"fullname":"","lng":120.14041,"kb_id":"","id":57690,"phone":"","lat":30.2808}},{"offset_lng":120.138454287866,"offset_lat":30.2807147536568}];

    function rad(d) {
      return d * Math.PI / 180.0;
    }

function GetDistance(lat1,  lng1,  lat2,  lng2) {
  //alert(lat1+", "+lng1+", "+lat2+", "+lng2);
  var radLat1 = rad(lat1);
  var radLat2 = rad(lat2);
  var a = radLat1 - radLat2;
  var b = rad(lng1) - rad(lng2);
  var s = 2 * Math.asin(Math.sqrt(Math.pow(Math.sin(a/2),2) + Math.cos(radLat1)*Math.cos(radLat2)*Math.pow(Math.sin(b/2),2)));
  s = s *6378.137 ;// EARTH_RADIUS;
  s = Math.round(s * 10000) / 10;
  return s;
}

var lat_cur=null, lng_cur=null;

function set_latlng(lat, lng) {
  lat_cur = lat;
  lng_cur = lng;
  sessionStorage.setItem("lat_cur",lat_cur);
  sessionStorage.setItem("lng_cur",lng_cur);
}

function default_aroundme() {
  set_latlng(lat=30.28297540, lng=120.13373360);
  load_js("jquery.tmpl.js");
  aroundme();
}

function aroundme() {
  if(lat_cur==null) { 
    alert('无法定位当前位置，请稍后再摇！');
    return;
  }
  // var url2="http://www.1dooo.com/mshop/aroundme?lat="+lat_cur+"&lng="+lng_cur;
  var url2="http://127.0.0.1:3000/mshop/aroundme?lat="+lat_cur+"&lng="+lng_cur;
  //alert(url2);
  console.log(url2);
  var jqxhr = $.ajax({
type: 'GET',
url: url2,
dataType: "json"
})
.success(function(data, textStatus, jqXHR) { 
    sessionStorage.setItem("cur_shops",jqXHR.responseText);
    //alert(data[0].mshop.name);
    if(data.length>0){shops = []};
    var o_lat = lat_cur;
    var o_lng = lng_cur;
    console.log('cur  lat  ' + o_lat + '  lng  ' + o_lng);
    for(var i=0;i<data.length;i++){
    if (typeof data[i].mshop === "object") {
    shops.push(data[i]);
    } else {
    o_lat = data[i].offset_lat;
    o_lng = data[i].offset_lng;
    }
    }
    console.log('shops.length' + shops.length);
    console.log('offset  lat  ' + o_lat + '  lng  ' + o_lng);
    for(var i=0;i<shops.length;i++){
    console.log(shops[i].mshop);
    // shops[i].diff=GetDistance(lat_cur,lng_cur,shops[i].mshop.lat,shops[i].mshop.lng);
    shops[i].diff=GetDistance(o_lat, o_lng,shops[i].mshop.lat,shops[i].mshop.lng);
    sessionStorage.setItem("shop" + shops[i].mshop.id + '_lat', shops[i].mshop.lat);
    sessionStorage.setItem("shop" + shops[i].mshop.id + '_lng', shops[i].mshop.lng);
    }
    $("#shopTemplate").tmpl(shops).appendTo("#content");
    // $("#map_button").show();
})
.fail(function(jqXHR0, textStatus) {
    alert( "获取商家信息失败!"+ textStatus);
    });
}

function onBodyLoad() {
  clear_sessionStorage();
  document.addEventListener("deviceready", device_ready, false);
}
function show_gps_info(position) {
  alert('Latitude: '          + position.coords.latitude          + '\n' +
      'Longitude: '         + position.coords.longitude         + '\n' +
      'Altitude: '          + position.coords.altitude          + '\n' +
      'Accuracy: '          + position.coords.accuracy          + '\n' +
      'Altitude Accuracy: ' + position.coords.altitudeAccuracy  + '\n' +
      'Heading: '           + position.coords.heading           + '\n' +
      'Speed: '             + position.coords.speed             + '\n' +
      'Timestamp: '         + new Date(position.timestamp)      + '\n');
}
var onSuccess = function(position) {
  //show_gps_info(position);
  lat_cur = position.coords.latitude;
  lng_cur = position.coords.longitude;
  sessionStorage.setItem("lat_cur",lat_cur);
  sessionStorage.setItem("lng_cur",lng_cur);
  $("#gps_lat").html(lat_cur);
  $("#gps_lng").html(lng_cur);
  $("#gps_diff").html(position.coords.accuracy);
  //aroundme();
};
function onError(error) {
  alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
}
function load_js(url) {
  var oHead = document.getElementsByTagName('HEAD').item(0); 
  var oScript= document.createElement("script"); 
  oScript.type = "text/javascript"; 
  oScript.src=url; 
  oHead.appendChild( oScript); 
}
function get_gps_location() {
  // alert('geolocation' + navigator.geolocation);
  // alert(navigator.geolocation.getCurrentPosition(onSuccess, onError));
  // alert(navigator.geolocation.getCurrentPosition(onSuccess, onError, { enableHighAccuracy: true }));
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(onSuccess, onError, { enableHighAccuracy: true });
  } else {
    alert('设备不支持定位');
  }
}
function device_ready() {
  get_gps_location();
  acc_startWatch(yaole);
  load_js("jquery.tmpl.js");
}

function show_map() {
  $("#map_canvas").show();
  initialize(lat_cur,lng_cur);
  initialize_marker(lat_cur,lng_cur);
}

function yaole() {
  if(lat_cur==null) {
    alert("无法定位当前位置，请稍后再摇！");
    return false;
  }
  //$("#yy")[0].src="wait (2).gif";
  document.getElementById("yy").src="./wait.gif"
    my_media = new Media("./sent.mp3");
  my_media.play();
  aroundme();
  return true;
}

function shop_map(mshop_id) {
  sessionStorage.setItem("lat_cur", sessionStorage.getItem('shop'+mshop_id+'_lat') );
  sessionStorage.setItem("lng_cur", sessionStorage.getItem('shop'+mshop_id+'_lng') );
  window.location.href = 'map.htm';
}

function clear_sessionStorage() {
  sessionStorage.clear(); 
}
</script>
<script type="text/javascript">
  set_latlng(30.28297540, 120.13373360);
  load_js("jquery.tmpl.js");
  $(function() {
      $('#content').scrollPagination({
        'contentPage': 'http://192.168.8.113:3000/mshop/aroundme', // the page where you are searching for results
        'contentData': { 'lat': sessionStorage.getItem("lat_cur"), 'lng': sessionStorage.getItem("lng_cur"), 'page': (parseInt(sessionStorage.getItem("page")) >= 1 ? parseInt(sessionStorage.getItem("page")) : 0) + 1 }, // you can pass the children().size() to know where is the pagination
        'scrollTarget': $(window), // who gonna scroll? in this example, the full window
        'heightOffset': 10, // how many pixels before reaching end of the page would loading start? positives numbers only please
        'beforeLoad': function(){ // before load, some function, maybe display a preloader div
        $('#loading').fadeIn();
        },
        'afterLoad': function(elementsLoaded){ // after loading, some function to animate results and hide a preloader div
        sessionStorage.setItem("page", (parseInt(sessionStorage.getItem("page")) >= 1 ? parseInt(sessionStorage.getItem("page")) : 0) + 1);
        $('#loading').fadeOut();
        $(elementsLoaded).fadeInWithDelay();
        if (elementsLoaded.children().size() <= 0){
        $('#nomoreresults').fadeIn();
        $('#content').stopScrollPagination();
        }
        }
        });

      // code for fade in element by element with delay
      $.fn.fadeInWithDelay = function(){
        var delay = 0;
        return this.each(function(){
            $(this).delay(delay).animate({opacity:1}, 200);
            delay += 100;
            });
      };
  });
</script>
    </head> 
    <body onload="onBodyLoad()"> 
      <div data-role="page" class="type-interior">
        <div data-role="header" data-theme="f">
          <h1>附近的商家</h1>
          <a href="#" onclick="aroundme();" data-role="button">获取</a>
          <a href="#" onclick="default_aroundme();" data-role="button">30/120附近</a>
          <a href="javascript:;" onclick="clear_sessionStorage();" data-role="button">清除 sessionStorage</a>
          <a id="map_button" href="map.htm" style="display:none">地图</a>
        </div><!-- /header -->
        <div data-role="content">
          <div>
            <br>
            <img id="yy" src="y1y.png" onclick="document.location='./acc2.htm';"/>
            <br>
            <center>摇一摇，查看附近的商家</center>
            <br>
          </div>               
          <div class="content-primary">
            当前位置：经度<span id="gps_lat"></span>,纬度<span id="gps_lng"></span>, 误差：<span id="gps_diff"></span>米 <a onclick="get_gps_location();">刷新</a>
            <ul id="content" scrollpagination="disabled" data-role="listview">
              <script id="shopTemplate" type="text/x-jquery-tmpl">
                <li data-corners="false" data-shadow="false" data-iconshadow="true" data-inline="false" data-wrapperels="div" data-icon="arrow-r" data-iconpos="right" data-theme="c" class="ui-btn ui-btn-up-c ui-btn-icon-right ui-li-has-arrow ui-li"><div class="ui-btn-inner ui-li"><div class="ui-btn-text"><a href="javascript:;" onclick="javascript:shop_map(${mshop.id});" class="ui-link-inherit">${mshop.name} ${diff}米</a><span>${mshop.address}</span></div><span class="ui-icon ui-icon-arrow-r ui-icon-shadow"></span></div></li>
              </script>
            </ul>
            <div class="loading" id="loading">加载中...</div>
            <div class="loading" id="nomoreresults">没有更多信息了。</div>
          </div><!--/content-primary -->		
        </div><!-- /content -->
        <div data-role="footer" class="footer-docs" data-theme="c">
          <p onclick="document.location='./index2.html';">&copy; Copyright 2011-2012 脸脸</p>
        </div>
      </div><!-- /page -->
    </body>
  </html>
