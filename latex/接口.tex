\documentclass[cs4size]{ctexartutf8} 
\usepackage[unicode={true}]{hyperref}
\hypersetup{colorlinks,%
                 citecolor=black,%
                 filecolor=black,%
                 linkcolor=black,%
                 urlcolor=blue,%
                 pdftex}

\usepackage{graphicx}
\usepackage{float}

				
\author{YXY}
\title{脸脸网服务器与手机端的开发接口API}

\begin{document} 

\maketitle
\tableofcontents

\newpage

\textbf{注意事项}：
\begin{enumerate}
\item 所有的链接，如果要获得json格式的数据，最好带上".json"的后缀。因为同一个链接以后可能返回多种格式的数据，比如xml/html/json等。
\item 获得附近的商家分解为三个API，对应三种情况。
\item 新浪微博登录回调以后的API调用时都需要登录。目前登录信息通过cookie中的“\_session\_id”获得。
\item 当调用出错时，会在返回的json中包含"error"信息。
\end{enumerate}

\newpage


\section{根据IP地址获得可能的现场商家}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/aroundme/shops\_by\_ip} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 ip  & 字符串 & 可选 & 默认为访问者的IP地址\\
\hline
\end{tabular}
   \end{center}
\end{table}


最多返回10条数据，同一个IP地址商家应该不多。

例子：

\begin{figure}[H]
\begin{verbatim}
访问：/aroundme/shops_by_ip.json
返回值：

[
	{
	"name":"新紫轩花店",
	"address":"文一路266号",
	"lng":120.12763,
	"id":40056,
	"phone":"",
	"lat":30.28691,
	"user":0,
	"male",0,
	"female",0
	}
]

除了返回商家的id、名称、电话、经纬度以后，增加了在该商家的用户总数“user”、男“male”、女“female”数量。

\end{verbatim}
\end{figure}





\section{根据经纬度获得可能的现场商家}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/aroundme/shops} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 lat  & 浮点数 & 必须 & 经度\\
\hline
 lng  &  浮点数 & 必须 & 纬度\\ 
\hline
 accuracy  & 整数 & 必须 & 经纬度的精确度\\ 
\hline
\end{tabular}
   \end{center}
\end{table}

返回值格式和根据IP地址获得可能的现场商家的返回值格式一样。

最多返回10条数据。



\section{根据经纬度获得附近的商家}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/mshop/nearby} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 lat  & 浮点数 & 必须 & 经度\\
\hline
 lng  &  浮点数 & 必须 & 纬度\\ 
\hline
 accuracy  & 整数 & 必须 & 经纬度的精确度\\ 
 \hline
 page  & 整数 & 可选 & 分页，缺省值为1\\ 
 \hline
 pcount  & 整数 & 可选 & 每页的数量，缺省为20\\ 
  \hline
 name  & 字符串 & 可选 & 商家的名称\\ 
  \hline
 type  & 整数 & 可选 & 1酒吧 • 活动2咖啡 • 茶馆3餐饮 • 酒店4运动 • 休闲5购物 • 广场\\  
\hline
\end{tabular}
   \end{center}
\end{table}

用户当前所在的现场只有一个，但是由于定位有误差，所以服务器返回最有可能的几个商家让用户选择；而附近的商家有很多，按距离由近到远排序，且支持查询、分类筛选和分页。



\section{根据经纬度获得附近的用户}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/aroundme/users} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 lat  & 浮点数 & 必须 & 经度\\
\hline
 lng  &  浮点数 & 必须 & 纬度\\ 
\hline
 accuracy  & 整数 & 必须 & 经纬度的精确度\\ 
  \hline
 page  & 整数 & 可选 & 分页，缺省值为1\\ 
 \hline
 pcount  & 整数 & 可选 & 每页的数量，缺省为20\\ 
\hline
\end{tabular}
   \end{center}
\end{table}


例子：

\begin{figure}[H]
\begin{verbatim}
访问：/aroundme/users.json?lat=30.2829754&lng=120.1337336&accuracy=100
返回值：

[
{"id":1,
"logo":"/phone2/images/namei2.gif",
"name":"name23",
"wb_uid":1884834632,
"gender":0,
"friend":true,
"follower":false,
"birthday":null}
]

如果用户登录后访问该API，那么返回的属性中包括"friend"和"follower"。

"friend"表示该用户是否是当前用户的朋友；"follower"代表该用户是否关注了当前用户。


\end{verbatim}
\end{figure}



\section{根据商家ID获得当前在该商家的所有用户}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/mshop/users} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 & 商家的ID\\
\hline
\end{tabular}
   \end{center}
\end{table}

返回值格式和“根据经纬度获得附近的用户”一致。

在商家的用户的统计数据根据签到来统计，而签到则是当用户进入商家聊天室时自动后台发送。当用户进入下一个商家时，自动判定为离开上一个商家。如果用户没有退出，那么默认12小时后用户离开商家。

在商家的用户的集合要保证大于在该商家聊天室的用户的集合。

当前的商家用户数据则完全是基于方便测试的目的构造的。




\section{新浪微博登录后的回调页}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/oauth2/sina\_callback} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 code  & 字符串 & 必须 &  新浪返回的code\\
\hline
\end{tabular}
   \end{center}
\end{table}


例子：

\begin{figure}[H]
\begin{verbatim}
访问：http://www.dface.cn/oauth2/sina_callback?code=...
该访问由新浪微博通过302转向发起。
返回值：

{
"id":1,
"password":"15c663b8ff620502",
"logo":"",
"wb_uid":"1884834632",
"expires_in":75693,
"token":"2.00aaZYDCMcnDPCb4dc439e06i2m_GC",
"expires_at":1338431259
}

其中，id和password是该用户在脸脸网的id和密码，在首次新浪授权时创建。该id加上"@dface.cn"就是openfire的jid。（目前还没有和jid关联上。）

后面几个字段都是新浪提供的，其中wb_uid是该用户的新浪微博的uid，token是授权的access_token，其它几个是授权有效期信息。

在首次登录获得用户的id和password以后，可以缓存到本地。以后用户每次登录，返回的id和password是不会改变的，除非服务器端重置密码（比如出现密码泄漏等安全情况）。

logo可以得知用户是否成功上传头像。对于第一次登录的用户，其logo为空，此时需要引导用户上传头像。


\end{verbatim}
\end{figure}


\section{进入现场签到}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/checkins} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 lat  & 浮点数 & 必须 & 经度\\
\hline
 lng  &  浮点数 & 必须 & 纬度\\ 
\hline
 accuracy  & 整数 & 必须 & 经纬度的精确度\\ 
\hline
 mshop\_id  & 整数 & 必须 &  现场商家id\\ 
\hline
 user\_id  & 整数 & 必须 &  签到用户id\\ 
\hline
\end{tabular}
   \end{center}
\end{table}

注意：该请求必须是POST请求。如果是GET请求，获得的是签到列表。



\section{获得用户基本信息}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/user\_info/get} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 &  用户id\\
\hline
\end{tabular}
   \end{center}
\end{table}


例子：

\begin{figure}[H]
\begin{verbatim}
访问：/user_info/get?id=1
返回值：

{
"name":null,
wb_uid:1884834632
"gender":null,
"logo":"/system/avatars/1/original/clojure.png?1339398140",
"logo_thumb":"/system/avatars/1/thumb/clojure.png?1339398140"
"birthday":null,
"friend":true,
"follower":false,
"id":1
}

获得用户基本信息里有两个关系字段：friend和follower。这里的关系都是针对我的，这里的我就是当前登录用户。如果我关注了该用户，那么该用户就是我的friend; 如果该用户关注了我，那么他就是我的follower。

\end{verbatim}
\end{figure}


\section{获得用户的头像}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/user\_info/logo} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 &  用户id\\
\hline
 size  & 整数 & 可选 &  目前0代表原图；1代表thumb缩略图，大小为75*75；2代表thumb2缩略图，大小为150*150。默认为1。\\ 
\hline
\end{tabular}
   \end{center}
\end{table}


输出的Response Header中包含“Img\_url”头，这个头就是查看用户信息时显示的用户头像的路径。

例如：“Img\_url:/system/avatars/1/thumb2/1.png?1339649979”

Response Body中包含头像的二进制信息。


\section{获得当前登录用户基本信息}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/user\_info/get\_self} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
\end{tabular}
   \end{center}
\end{table}

例子：

\begin{figure}[H]
\begin{verbatim}
访问：/user_info/get_self
返回值：

{
"name":null,
wb_uid:1884834632
"gender":null,
"birthday":null,
"invisible":0,
"logo":"/system/avatars/1/original/clojure.png?1339398140",
"logo_thumb":"/system/avatars/1/thumb/clojure.png?1339398140"
"password":"c84dad462d5b7282",
"id":1
}

\end{verbatim}
\end{figure}



\section{设置当前登录用户基本信息}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/user\_info/set} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 name  & 字符串 & 选填 &  用户的名字\\
\hline
 gender  & 数字 & 选填 &  用户的性别，未设置0男1女2\\
\hline
 birthday  & 字符串 & 选填 &  用户的生日,格式如2012-06-01\\
 \hline
 invisible  & 数字 & 选填 &  0：不隐身,1：对陌生人隐身,2：全部隐身\\
\hline
\end{tabular}
   \end{center}
\end{table}

注意：该请求必须是POST请求。

用户初次登录时获取这些信息并提交到服务端。以后更新时可以只更新其中的某个字段。

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -b "_session_id=ead9ac4f6291c55bb467ad4138eca2ed" 
        -F "name=newname" http://www.dface.cn/user_info/set

返回值：

{
"name":newname,
"gender":null,
"birthday":null,
"logo":"/system/avatars/1/original/clojure.png?1339398140",
"logo_thumb":"/system/avatars/1/thumb/clojure.png?1339398140"
"id":1
}

\end{verbatim}
\end{figure}


\section{设置当前登录用户的头像}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/user\_logos} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 user\_logo[avatar]  & file & 必须 &  头像文件\\
\hline
\end{tabular}
   \end{center}
\end{table}

注意：

\begin{enumerate}
\item 该请求必须是POST请求，enctype="multipart/form-data"。
\item 所上传文件的type必须是image/jpeg', 'image/gif' 或者'image/png'。
\item 图片文件必须小于5M。
\item 图片名为logo；缩略图分为两种大小，logo\_thumb为75*75的png，logo\_thumb2为150*150的png。
\end{enumerate}

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -F "user_logo[avatar]=@firefox.png;type=image/png" 
http://www.dface.cn/user_logos

返回值和设置个人信息一样。

\end{verbatim}
\end{figure}





\section{添加我关注的人}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/follows} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 user\_id  & 整数 & 必须 &  当前登录用户的id\\
\hline
 follow\_id  & 整数 & 必须 &  关注用户的id\\
\hline
\end{tabular}
   \end{center}
\end{table}

注意：该请求必须是POST请求。

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -b "_session_id=f03bef9371c119b6fcecbeefdaaac1b2"
       -d "user_id=2&follow_id=1" http://www.dface.cn/follows

返回值：

{
"id":1,
"user_id":2,
"follow_id":1
}

\end{verbatim}
\end{figure}



\section{删除我的关注的人}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/follows/delete} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 user\_id  & 整数 & 必须 &  当前登录用户的id\\
\hline
 follow\_id  & 整数 & 必须 &  关注用户的id\\
\hline
\end{tabular}
   \end{center}
\end{table}

注意：该请求必须是POST请求。

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -b "_session_id=f03bef9371c119b6fcecbeefdaaac1b2"
       -d "user_id=2&follow_id=3" http://www.dface.cn/follows/delete

返回值：

{
"deleted":3
}

\end{verbatim}
\end{figure}





\section{粉丝列表}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/follow\_info/followers} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 & 用户的id\\
   \hline
 page  & 整数 & 可选 & 分页，缺省值为1\\ 
 \hline
 pcount  & 整数 & 可选 & 每页的数量，缺省为20\\ 
    \hline
 name  & 字符串 & 可选 & 用户的名字\\ 
    \hline    
 hash  & 整数 & 可选 & 是否返回hash，缺省值为0\\ 
\hline

\end{tabular}
   \end{center}
\end{table}

例子：

\begin{figure}[H]
\begin{verbatim}
访问：/follow_info/followers?id=2

返回值：

[
{"count":1}
{"data":
{"id":1,
"name":"name23",
"wb_uid":1884834632,
"gender":0,
"friend":true,
"follower":true,
"birthday":null}
}
]

其中count是符合条件的粉丝的总数。

获得用户基本信息里有两个关系字段：friend和follower。这里的关系都是针对我的，这里的我就是给定ID的用户。如果我关注了该用户，那么该用户就是我的friend; 如果该用户关注了我，那么他就是我的follower。

这里返回的所有用户，其"follower"值一定为true。


\end{verbatim}
\end{figure}





\section{关注(好友)列表}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://www.dface.cn/follow\_info/friends} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 &  用户的id\\
   \hline
 page  & 整数 & 可选 & 分页，缺省值为1\\ 
 \hline
 pcount  & 整数 & 可选 & 每页的数量，缺省为20\\ 
     \hline
 name  & 字符串 & 可选 & 用户的名字\\ 
     \hline
 hash  & 整数 & 可选 & 是否返回hash，缺省值为0\\ 
\hline

\end{tabular}
   \end{center}
\end{table}

返回的内容格式同粉丝列表一样

这里返回的所有用户，其"friend"值一定为true。


\section{Openfire聊天服务器接口}




\begin{enumerate}
\item 脸脸网的用户id加上"@dface.cn"就是openfire的jid，两个系统的密码一致。
\item 商家的id加上"@conference.dface.cn"就是现场聊天室的jid。
\item 脸脸的用户名就是openfire的用户名，且也就是聊天时的用户名。Xmpp协议允许用户在加入聊天室时取一个名字，脸脸的聊天室应该忽略该名字。
\item 脸脸中的关注和粉丝关系是单向的，和xmpp中的好友roster关系无关。
\item 只要用户登录，其xmpp协议中的presence就是在线，没有其它状态。
\item 脸脸中的隐身也和xmpp中的隐身状态无关。
\item xmpp中的任意两个用户可以发送消息，不管对方是否隐身，只要对方未设置黑名单即可。如果对方未登录，那么就是离线消息。
\end{enumerate}



\newpage


\end{document}
