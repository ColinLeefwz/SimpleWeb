\documentclass[cs4size]{ctexartutf8} 
\usepackage[unicode={true}]{hyperref}
\hypersetup{colorlinks,%
                 citecolor=black,%
                 filecolor=black,%
                 linkcolor=black,%
                 urlcolor=blue,%
                 pdftex}

\usepackage{graphicx}
\usepackage{float}

				
\author{YXY}
\title{脸脸网服务器与手机端的开发接口API}

\begin{document} 
\maketitle
\tableofcontents

\newpage

\textbf{注意事项}：
\begin{enumerate}
\item 所有的链接，如果要获得json格式的数据，最好带上".json"的后缀。因为同一个链接以后可能返回多种格式的数据，比如xml/html/json等。
\item 当调用出错时，会在返回的json中包含"error"信息。
\item 只有开发调试时调用http的接口，发布时全部使用https接口。
\end{enumerate}

\newpage

\section{初始化}
手机应用启动后，初次访问时调用此API。
\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{https://42.121.79.210/init/init} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
 \hline
 model  & 字符串 & 必须 &  硬件型号\\
\hline
 os  & 字符串 & 必须 &  手机操作系统版本\\
 \hline
 mac  & 字符串 & 必须 &  无线网卡MAC地址的MD5\\
 \hline
 hash  & 字符串 & 必须 &  hash验证码\\
  \hline
 ver  & 字符串 & 可选 &  软件版本\\
\hline
\end{tabular}
   \end{center}
\end{table}

注意：本API直接通过IP地址“42.121.79.210”访问，不通过DNS。而后续所有API调用的IP地址根据本调用的返回的IP地址确定。在目前只有单台服务器的情况下，返回的ip地址也是“42.121.79.210”，但是以后会根据离用户的距离返回就近的IP地址。


hash的计算方式为：model+os+mac+"init"进行SHA1算法后取前32位，和登录时的hash算法［\ref{hash_algorithm}］类似。

\begin{verbatim}
返回值：
{
"ip": "60.191.119.190",
"xmpp": "60.191.119.190",
"ver":1.0
}

后续的http访问使用返回的ip地址，xmpp协议的访问使用xmpp地址。

[2012-12-27] 新增ver，表示脸脸当前线上的最新版本。客户端根据这个版本号可以判断是否需要升级。如果需要升级，提醒用户一次，不要每次启动重复提醒。比如1.1版本时提醒一次，如果用户忽略了，那么只有当版本升级到了1.2时再提醒一次。

\end{verbatim}

本API的作用一个是给客户端推荐IP地址，一个是统计应用的开机情况和操作系统分布。




\section{登录和退出}
\subsection{老的登录方式：oauth2}


\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/oauth2/sina\_callback} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 code  & 字符串 & 必须 &  新浪返回的code\\
\hline
\end{tabular}
   \end{center}
\end{table}


例子：

\begin{figure}[H]
\begin{verbatim}
访问：/oauth2/sina_callback?code=...
该访问由新浪微博通过302转向发起。
返回值：

{
"id":1,
"password":"15c663b8ff620502",
"logo":"",
"name" : "name"
"gender" : 1
"wb_uid":"1884834632",
"expires_in":75693,
"token":"2.00aaZYDCMcnDPCb4dc439e06i2m_GC",
"expires_at":1338431259
}

其中，id和password是该用户在脸脸网的id和密码，在首次新浪授权时创建。该id加上"@dface.cn"就是openfire的jid。（目前还没有和jid关联上。）

后面几个字段都是新浪提供的，其中wb_uid是该用户的新浪微博的uid，token是授权的access_token，其它几个是授权有效期信息。

在首次登录获得用户的id和password以后，可以缓存到本地。以后用户每次登录，返回的id和password是不会改变的，除非服务器端重置密码（比如出现密码泄漏等安全情况）。

logo可以得知用户是否成功上传头像。对于第一次登录的用户，其logo为空，此时需要引导用户上传头像。


\end{verbatim}
\end{figure}

\subsection{新的登录方式：xauth}
\label{hash_algorithm}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/oauth2/login} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 name  & 字符串 & 必须 &  用户名\\
 \hline
 pass  & 字符串 & 必须 &  密码\\
  \hline
 mac  & 字符串 & 必须 &  网卡Mac地址\\
 \hline
 hash  & 字符串 & 必须 &  hash验证码\\
\hline
\end{tabular}
   \end{center}
\end{table}

本接口的输出和oauth2登录接口的输出相同。

\begin{verbatim}
hash的计算方式为：name+pass+mac+"dface"进行SHA1算法后取前32位。
比如用户名为name，密码为pa，mac地址为ss
那么待hash的字符串为"namepassdface"，
其hash码为"11f4004a73a65117071bc4a7d3dfdf07"。
\end{verbatim}

新的登录方式不需要调用新浪的Xauth API，直接调用本API即可以登录。客户端应该不需要保存AppSecret。通过预先保存的AppKey和本调用输出中包含的token应该就可以访问新浪微博的API了。



\subsection{退出}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/oauth2/logout} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
    pushtoken  & 浮点数 & 可选 &  当前设备的push消息token\\
\hline
\end{tabular}
   \end{center}
\end{table}

当用户主动退出时，调用本接口并断开XMPP的连接。
[2012-12-30] 新增pushtoken参数。

\section{首次使用脸脸时发送分享微博}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/oauth2/share} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
   ver  & 浮点数 & 可选 &  当前安装的版本\\
\hline
\end{tabular}
   \end{center}
\end{table}

首次使用脸脸／或者以后重大版本更新时，以登陆用户个人的名义发送使用脸脸的分享微博，微博由服务器端发送。


\section{根据经纬度获得可能的现场商家}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/aroundme/shops} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 lat  & 浮点数 & 必须 & 经度\\
\hline
 lng  &  浮点数 & 必须 & 纬度\\ 
\hline
 accuracy  & 整数 & 必须 & 经纬度的精确度\\ 
\hline
\end{tabular}
   \end{center}
\end{table}

注意：一定要在accuracy小于200m或者调用获取GPS的API超过三次后才能调用本接口。

Gps获取位置是一个逐步精确的过程。很多时候首次获取的误差超过1000米。此时显然无法准确获得商家列表。此时建议等待0.5秒再次获取gps。要保证gps的精确度小于200m，或则定位三次以上确实不能更准确了。宁可等待的时间久一些，也要保证定位的准确性。

最多返回50条数据，也有可能没有数据（比如西部沙漠地区）。

例子：

\begin{figure}[H]
\begin{verbatim}
访问：/aroundme/shops.json
返回值：

[
	{
	"name":"新紫轩花店",
	"address":"文一路266号",
	"lng":120.12763,
	"id":40056,
	"phone":"",
	"lat":30.28691,
	"lo":[30.297,120.1288],
	"t":1,
	"user":0,
	"male",0,
	"female",0
	}
]

除了返回商家的id、名称、电话、经纬度以后，增加了在该商家的用户总数“user”、男“male”、女“female”数量。

[2012－8－7] 新增lo字段。这是商家的实际经纬度，以前的lat/lng是地图上显示的经纬度，两者有几百米的误差。计算商家和自己的距离时，要采用lo来计算。

[2012－8－8] 新增t字段，表示商家的类型。

\end{verbatim}
\end{figure}



\section{根据经纬度获得附近的商家}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/shop/nearby} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 lat  & 浮点数 & 必须 & 经度\\
\hline
 lng  &  浮点数 & 必须 & 纬度\\ 
\hline
 accuracy  & 整数 & 必须 & 经纬度的精确度\\ 
 \hline
 page  & 整数 & 可选 & 分页，缺省值为1\\ 
 \hline
 pcount  & 整数 & 可选 & 每页的数量，缺省为20\\ 
  \hline
 name  & 字符串 & 可选 & 商家的名称\\ 
  \hline
 type  & 整数 & 可选 & 商家类型\\  
\hline
\end{tabular}
   \end{center}
\end{table}

商家类型：
\begin{enumerate}
\item 酒吧• 活动
\item 咖啡• 茶馆   
\item 餐饮• 酒店
\item 休闲• 娱乐
\item 购物• 广场
\item 楼宇• 社区
\end{enumerate}


用户当前所在的现场只有一个，但是由于定位有误差，所以服务器返回最有可能的几个商家让用户选择；而附近的商家有很多，按距离由近到远排序，且支持查询、分类筛选和分页。



\section{获得附近的用户}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/aroundme/users} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
 \hline
 gender  & 数字 & 必填 &  用户的性别，未设置0男1女2\\
\hline
\end{tabular}
   \end{center}
\end{table}

输出格式和“根据商家ID获得商家用户”的接口一样。


\section{根据商家ID获得商家的基本信息}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/shop/info} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 & 商家的ID\\
\hline
\end{tabular}
   \end{center}
\end{table}

例子：

\begin{figure}[H]
\begin{verbatim}

{
    "name": "浙江科技产业大厦",
    "t": 6,
    "lat": 30.280254,
    "lng": 120.121824,
    "address": "古翠路80",
    "id": 4928288,
    "staffs": [
        "502e6303421aa918ba000001"
    ],
    "notice":""
}

staffs是该商家的员工数组。在商家聊天室，商家和商家的员工发言时都加V并加黄色背景。只有该商家在商家聊天室才加V，其它商家不做特殊处理。

notice是该商家发布的公告。

\end{verbatim}
\end{figure}

\section{根据商家ID获得当前在该商家的所有用户}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/shop/users} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 & 商家的ID\\
  \hline
 page  & 整数 & 可选 & 分页，缺省值为1\\ 
 \hline
 pcount  & 整数 & 可选 & 每页的数量，缺省为20\\ 
\hline
\end{tabular}
   \end{center}
\end{table}


例子：

\begin{figure}[H]
\begin{verbatim}

[
{"id":1,
"logo":"/phone2/images/namei2.gif",
"name":"name23",
"wb_uid":1884834632,
"gender":0,
"friend":true,
"follower":false,
"birthday":null}
]

"friend"表示该用户是否是当前用户的朋友；"follower"代表该用户是否关注了当前用户。

[2012－8－8] 新增time字段，表示用户在该商家的最后活跃时间。
[2012－10－30] 新增分页参数。


\end{verbatim}
\end{figure}



在商家的用户的统计数据根据签到来统计，而签到则是当用户进入商家聊天室时自动后台发送。


\section{进入现场签到}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/checkins} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 lat  & 浮点数 & 必须 & 经度\\
\hline
 lng  &  浮点数 & 必须 & 纬度\\ 
\hline
 accuracy  & 整数 & 必须 & 经纬度的精确度\\ 
\hline
 shop\_id  & 整数 & 必须 &  现场商家id\\ 
\hline
 user\_id  & 整数 & 必须 &  签到用户id\\ 
\hline
 od  & 整数 & 必须 &  实际签到的商家的排序\\  
\hline
 altitude  &  浮点数 & 可选 & 海拔高度\\ 
\hline
 altacc  & 整数 & 可选 & 海拔高度的精确度\\  
\hline
 bssid  & 字符串 & 可选 & wifi上网时的bssid，如果不是wifi上网则忽略\\  
\hline
\end{tabular}
   \end{center}
\end{table}

注意：该请求必须是POST请求。如果是GET请求，获得的是签到列表。

[2012－8－10] 新增od字段，表示用户实际签到的商家在现场商家列表中的顺序位置，从1开始，也就是从/aroundme/shops中获得的商家列表中，那个被用户选中了。



\section{获得用户基本信息}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/user\_info/get} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 &  用户id\\
\hline
\end{tabular}
   \end{center}
\end{table}



例子：

\begin{figure}[H]
\begin{verbatim}
访问：/user_info/get?id=1
返回值：

{
"name":null,
wb_uid:1884834632
"gender":null,
"logo":"/system/imgs/1/original/clojure.png?1339398140",
"logo_thumb":"/system/imgs/1/thumb/clojure.png?1339398140"
"birthday":null,
"friend":true,
"follower":false,
"signature":"","job":null,"jobtype":null,"hobby":"Weiqi, go",
"last": "1天以前 顺旺基(益乐路店)" 
"id":1
}

获得用户基本信息里有两个关系字段：friend和follower。这里的关系都是针对我的，这里的我就是当前登录用户。如果我关注了该用户，那么该用户就是我的friend; 如果该用户关注了我，那么他就是我的follower。

[2012－8－8] 新增签名、职业、爱好等字段。
[2012－8－8] 新增last字段，表示用户最后在脸脸上的时间和地点，一个以空格分割的字符串。

\end{verbatim}
\end{figure}


\section{获得用户的头像}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/user\_info/logo} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 &  用户id\\
\hline
 size  & 整数 & 可选 &  目前0代表原图；1代表thumb缩略图，大小为100*100；2代表thumb2缩略图，大小为200*200。默认为1。\\ 
\hline
\end{tabular}
   \end{center}
\end{table}


输出的Response Header中包含“Img\_url”头，这个头就是查看用户信息时显示的用户头像的路径。

例如：“Img\_url:/system/imgs/1/thumb2/1.png?1339649979”

注意：采用阿里云存储后，会输出302重定向，而不是直接给二进制流。


\section{获得用户的图片列表}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/user\_info/photos} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 &  用户id\\
\hline
\end{tabular}
   \end{center}
\end{table}


例子：

\begin{figure}[H]
\begin{verbatim}
访问：/user_info/photos?id=1
返回值：

[
{"logo_thumb2":"/system/imgs/2/thumb2/2.png.png?1340616951","updated_at":"2012-06-25T09:35:51Z",
"id":2,"logo":"/system/imgs/2/original/2.png.png?1340616951","img_file_size":81881,"user_id":1,"logo_thumb":"/system/imgs/2/thumb/2.png.png?1340616951"},
{"logo_thumb2":"/system/imgs/4/thumb2/2.png.png?1340617039","updated_at":"2012-06-25T09:37:20Z",
"id":4,"logo":"/system/imgs/4/original/2.png.png?1340617039","img_file_size":81881,"user_id":1,"logo_thumb":"/system/imgs/4/thumb/2.png.png?1340617039"}
]

图片列表中的第一张图片就是用户的头像。


\end{verbatim}
\end{figure}



\section{获得当前登录用户基本信息}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/user\_info/get\_self} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
\end{tabular}
   \end{center}
\end{table}

例子：

\begin{figure}[H]
\begin{verbatim}
访问：/user_info/get_self
返回值：

{
"name":null,
wb_uid:1884834632
"gender":null,
"birthday":null,
"invisible":0,
"logo":"/system/imgs/1/original/clojure.png?1339398140",
"logo_thumb":"/system/imgs/1/thumb/clojure.png?1339398140"
"password":"c84dad462d5b7282",
"id":1
}

\end{verbatim}
\end{figure}


\section{获得当前登录用户的足迹}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/user\_info/trace} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
   \hline
 page  & 整数 & 可选 & 分页，缺省值为1\\ 
 \hline
 pcount  & 整数 & 可选 & 每页的数量，缺省为20\\ 
  \hline
 hash  & 整数 & 可选 & 是否返回hash，缺省值为0\\
 \hline
\end{tabular}
   \end{center}
\end{table}

例子：

\begin{figure}[H]
\begin{verbatim}
访问：/user_info/trace
返回值：
{"pcount":20,"data":
[{"id":"50b71b73c90d8b3c73000019","time":["09.22","14:24"],
"shop":"(下沙服务区)书报百货","shop_id":1,
"photos":[{"logo":"http://oss.aliyuncs.com/dface_test/5044301dbe4b192a30000002/0.jpg",
"logo_thumb2":"http://oss.aliyuncs.com/dface_test/5044301dbe4b192a30000002/t2_0.jpg",
"id":"5044301dbe4b192a30000002","desc":null}]},
{"time":["07.21","00:02"],"shop":"海洋二所","shop_id":60775,"photos":[]}]
}

其中pcount代表数据库中查询到的足迹的数量，如果该pcount等于客户端请求的数量，那么代表还会有更多的足迹。否则代表该用户没有足迹了。
而data中保存的实际返回的足迹，其数量可能少于数据库中查询到的足迹。比如一个人在一天内在同一个地方的签到会被合并。

data中的字段说明：
｛
id：签到id
time: ［签到日期，签到时间］
shop：商家
shop_id:商家id
photos ：［｛desc：图片描述，id：图片id，logo：原图URL，logo_thumb2：缩略图｝］
｝

\end{verbatim}
\end{figure}



\section{删除当前登录用户的一个签到足迹}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/checkins/delete} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
   \hline
 id  & 字符串 & 必须 & 签到的id\\ 
 \hline
\end{tabular}
   \end{center}
\end{table}

注意：该请求必须是POST请求。



\section{设置当前登录用户基本信息}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/user\_info/set} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 name  & 字符串 & 选填 &  用户的名字. 长度小于64\\
\hline
 gender  & 数字 & 选填 &  用户的性别，未设置0男1女2\\
\hline
 birthday  & 字符串 & 选填 &  用户的生日,格式如2012-06-01\\
 \hline
 signature  & 字符串 & 选填 &  签名档. 长度小于255\\
 \hline
 job  & 字符串 & 选填 &  职业\\
 \hline
 jobtype  & 整数 & 选填 &  职业类别\\
 \hline
 hobby  & 字符串 & 选填 &  爱好. 长度小于255\\
 \hline
 invisible  & 数字 & 选填 &  0：不隐身,1：对陌生人隐身,2：全部隐身\\
\hline
\end{tabular}
   \end{center}
\end{table}

注意：该请求必须是POST请求。

用户初次登录时获取新浪微博的名称／性别／出生日期等信息并提交到服务端。以后更新时可以只更新其中的某个字段。

隐身的效果是：
1、在商家的用户列表中不在出现该用户
2、不更新自己的位置信息
3、用户进入商家时，不发打招呼的信息。

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -b "_session_id=ead9ac4f6291c55bb467ad4138eca2ed" 
        -F "name=newname" /user_info/set

返回值：

{
"name":newname,
"gender":null,
"birthday":null,
"logo":"/system/imgs/1/original/clojure.png?1339398140",
"logo_thumb":"/system/imgs/1/thumb/clojure.png?1339398140"
"id":1
}

\end{verbatim}
\end{figure}


\section{当前登录用户上传图片}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/user\_logos/create} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 user\_logo[img]  & file & 必须 &  头像文件\\
\hline
\end{tabular}
   \end{center}
\end{table}

注意：

\begin{enumerate}
\item 该请求必须是POST请求，enctype="multipart/form-data"。
\item 所上传文件的type必须是image/jpeg', 'image/gif' 或者'image/png'。
\item 图片文件要在客户端先压缩到960*960。
\item 图片名为logo；缩略图分为两种大小，logo\_thumb为100*100的png，logo\_thumb2为200*200的png。
\end{enumerate}

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -F "user_logo[img]=@firefox.png;type=image/png" 
/user_logos


{"logo_thumb2":null, "logo_thumb1":null
,"id":6,
"logo":"",
"user_id":3,
"img_tmp":"/system/imgs/6/thumb/csky2.png?1340779488"}

\end{verbatim}

用户上传图片更改为异步操作。图片上传完成后返回图片的id，但是此时图片还没有实际的阿里云链接。客户端上传完成后，可以用下面的“根据图片id获得用户相册里的图片”接口尝试获得实际的上传图片和缩略图。

\end{figure}


\section{根据图片id获得用户相册里的图片}
\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/user\_logos/show} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
  \hline
 id  & 字符串 & 必须 & 图片id\\
\hline
 size  & 整数 & 可选 &  目前0代表原图；1代表thumb1缩略图，大小为100*100；2代表thumb2缩略图，大小为200*200。默认为1。\\ 
\hline
\end{tabular}
   \end{center}
\end{table}



\section{当前登录用户批量调整所有图片的位置}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/user\_logos/change\_all\_position} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 ids  & 逗号分割的整数 & 必须 &  所有图片的id按新的循序排列\\
\hline
\end{tabular}
   \end{center}
\end{table}

说明：

比如原有图片的循序是2468，新的循序是8642，此时需要调用本接口，传递ids=8,6,4,2。此时服务器会更新所有图片的排序，而客户端只需要发送一个请求。

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -F "ids=3,1,4" 
/user_logos/position




\end{verbatim}
\end{figure}



\section{当前登录用户删除图片}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/user\_logos/delete} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 &  图片的id\\
\hline
\end{tabular}
   \end{center}
\end{table}

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -F "id=2" 
/user_logos/delete

输出：
{"deleted":"2"}

\end{verbatim}
\end{figure}



\section{添加我关注的人}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/follows/create} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 user\_id  & 整数 & 必须 &  当前登录用户的id\\
\hline
 follow\_id  & 整数 & 必须 &  关注用户的id\\
\hline
\end{tabular}
   \end{center}
\end{table}

注意：该请求必须是POST请求。

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -b "_session_id=f03bef9371c119b6fcecbeefdaaac1b2"
       -d "user_id=2&follow_id=1" /follows

返回值：

{
"id":1,
"user_id":2,
"follow_id":1
}

\end{verbatim}
\end{figure}



\section{删除我的关注的人}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/follows/delete} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 user\_id  & 整数 & 必须 &  当前登录用户的id\\
\hline
 follow\_id  & 整数 & 必须 &  关注用户的id\\
\hline
\end{tabular}
   \end{center}
\end{table}

注意：该请求必须是POST请求。

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -b "_session_id=f03bef9371c119b6fcecbeefdaaac1b2"
       -d "user_id=2&follow_id=3" /follows/delete

返回值：

{
"deleted":3
}

\end{verbatim}
\end{figure}





\section{粉丝列表}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/follow\_info/followers} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 & 用户的id\\
   \hline
 page  & 整数 & 可选 & 分页，缺省值为1\\ 
 \hline
 pcount  & 整数 & 可选 & 每页的数量，缺省为20\\ 
    \hline
 name  & 字符串 & 可选 & 用户的名字\\ 
    \hline    
 hash  & 整数 & 可选 & 是否返回hash，缺省值为0\\ 
\hline

\end{tabular}
   \end{center}
\end{table}

例子：

\begin{figure}[H]
\begin{verbatim}
访问：/follow_info/followers?id=2

返回值：

[
{"count":1}
{"data":
{"id":1,
"name":"name23",
"wb_uid":1884834632,
"gender":0,
"friend":true,
"follower":true,
"birthday":null}
}
]

其中count是符合条件的粉丝的总数。

获得用户基本信息里有两个关系字段：friend和follower。这里的关系都是针对我的，这里的我就是给定ID的用户。如果我关注了该用户，那么该用户就是我的friend; 如果该用户关注了我，那么他就是我的follower。

这里返回的所有用户，其"follower"值一定为true。


\end{verbatim}
\end{figure}





\section{关注(好友)列表}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/follow\_info/friends} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 &  用户的id\\
   \hline
 page  & 整数 & 可选 & 分页，缺省值为1\\ 
 \hline
 pcount  & 整数 & 可选 & 每页的数量，缺省为20\\ 
     \hline
 name  & 字符串 & 可选 & 用户的名字\\ 
     \hline
 hash  & 整数 & 可选 & 是否返回hash，缺省值为0\\ 
\hline

\end{tabular}
   \end{center}
\end{table}

返回的内容格式同粉丝列表一样

这里返回的所有用户，其"friend"值一定为true。


\section{黑名单列表}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/blacklists} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 id  & 整数 & 必须 &  用户的id\\
   \hline
 page  & 整数 & 可选 & 分页，缺省值为1\\ 
 \hline
 pcount  & 整数 & 可选 & 每页的数量，缺省为20\\ 
     \hline
 name  & 字符串 & 可选 & 用户的名字\\ 
     \hline
 hash  & 整数 & 可选 & 是否返回hash，缺省值为0\\ 
\hline
\end{tabular}
   \end{center}
\end{table}

返回的内容格式和好友列表一样。


\section{添加黑名单}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/blacklists/create} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 user\_id  & 整数 & 必须 &  当前登录用户的id\\
\hline
 block\_id  & 整数 & 必须 &  加黑阻止的用户的id\\
 \hline
 report  & 整数 & 可选 &  是否同时举报被加黑的用户，0不举报1举报\\
\hline
\end{tabular}
   \end{center}
\end{table}

注意：该请求必须是POST请求。

\begin{figure}[H]
\begin{verbatim}

返回值：

{
"id":1,
"user_id":2,
"report":false,
"block_id":1
}

\end{verbatim}
\end{figure}



\section{删除黑名单}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/blacklists/delete} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 user\_id  & 整数 & 必须 &  当前登录用户的id\\
\hline
 block\_id  & 整数 & 必须 &  加黑用户的id\\
\hline
\end{tabular}
   \end{center}
\end{table}

注意：该请求必须是POST请求。

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -b "_session_id=f03bef9371c119b6fcecbeefdaaac1b2"
       -d "user_id=2&block_id=3" /blacklists/delete

返回值：

{
"deleted":3
}

\end{verbatim}
\end{figure}




\section{XMPP协议接口}


\subsection{与Openfire聊天服务器接口}
脸脸网的XMPP服务器采用的是Openfire。

\begin{enumerate}
\item 脸脸网的用户id加上"@dface.cn"就是openfire的jid，两个系统的密码一致。
\item 商家的id加上"@c.dface.cn"就是现场聊天室的jid。
\item 脸脸的用户名就是openfire的用户名，且也就是聊天时的用户名。Xmpp协议允许用户在加入聊天室时取一个名字，脸脸的聊天室应该忽略该名字。
\item 脸脸中的关注和粉丝关系是单向的，和xmpp中的好友roster关系无关。
\item 只要用户登录，其xmpp协议中的presence就是在线，没有其它状态。
\item 脸脸中的隐身也和xmpp中的隐身状态无关。
\item xmpp中的任意两个用户可以发送消息，不管对方是否隐身，只要对方未设置黑名单即可。如果对方未登录，那么就是离线消息。
\end{enumerate}


\subsection{脸脸中的聊天用户的三种类型}

\begin{enumerate}
\item管理员，其jid固定为"502e6303421aa918ba000001@dface.cn";
\item商家，其jid为's+商家id@dface.cn';
\item个人，其jid为'个人id@dface.cn'。
\end{enumerate}
如果一个jid以字母s开头，那么它一定是商家。


\subsection{摇一摇及其消息格式}
目前，用户在聊天室摇一摇时，客户端发送“用户名 摇了摇手机和大家say hello~”给服务器。这导致要分析摇一摇数据很困难，所以要为摇一摇定义特殊的消息格式。

\begin{verbatim}
摇一摇的消息格式为：
 [摇一摇:$name]

其它客户端收到摇一摇的消息后，再将其转换为文字描述。
\end{verbatim}



\subsection{个人之间聊天的消息发送状态确认}
XMPP协议的消息发送状态确认参考规范“\href{http://xmpp.org/extensions/xep-0022.html}{XEP-0022: Message Events}”。其定义了四种消息事件：Offline、Delivered、Displayed、Composing。Dface只需要其中的两种。

\begin{verbatim}
当接收端收到消息时，发送delivered确认消息，例如：
<message id="Kk98S-16" to="s6@dface.cn/ylt">
<x xmlns="jabber:x:event"><delivered/><id>purplea5e6669c</id></x>
</message>

当接收端展示消息时，发送displayed确认消息，例如：
<message id="Kk98S-17" to="s6@dface.cn/ylt">
<x xmlns="jabber:x:event"><displayed/><id>purplea5e6669c</id></x>
</message>

发送端根据从接收端获得的状态通知更改单条消息的发送状态。

只有类型是message,且body不为空的消息需要确认状态。

当本地无法发送消息时（比如无网络、或者连接不上xmpp服务器），消息的状态为“发送失败”。发送失败的消息可以再次发送。

\end{verbatim}


\section{在聊天室发图}
聊天发图主要流程是：客户端选择（拍摄）一张照片，通过http上传到服务器。上传完成后在xmpp里发送一个特定格式的消息。其它客户端收到消息后获取图片显示并发送回执消息。

\subsection{上传图片}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/photos/create} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 photo[img]  & file & 必须 &  头像文件\\
 \hline
 photo[room]  & 字符串 & 必须  &  聊天室的id\\
 \hline
 photo[weibo]  & 0/1 & 必须  &  是否同步发送到微博\\
   \hline
 photo[desc]  & 字符串 & 可选  &  图像的说明文字\\
 \hline
\end{tabular}
   \end{center}
\end{table}

注意：

\begin{enumerate}
\item 该请求必须是POST请求，enctype="multipart/form-data"。
\item 所上传文件的type必须是image/jpeg', 'image/gif' 或者'image/png'。
\item 图片文件要在客户端先压缩到960*960。
\item 图片名为logo；缩略图分logo\_thumb2为200*200的png。
\end{enumerate}

例子：

\begin{figure}[H]
\begin{verbatim}
访问：curl -F "photo[img]=@firefox.png;type=image/png" 
/photos

{"_id":"509a1ffcbe4b1982a4000002",
"weibo":false,"room":"1",
"user_id":"502e61bfbe4b1921da000005",
"img_tmp":"20121107-1646-42114-4251/111.jpg",
"logo":"/uploads/tmp/20121107-1646-42114-4251/111.jpg",
"logo_thumb2":null,"id":"509a1ffcbe4b1982a4000002"}

当返回的响应中包含img_tmp字段，且logo_thumb2为null时，说明此时图片上传到了服务器，但是还未启动后台处理。后台异步处理图片，包括生成缩略图以及上传到阿里云。

\end{verbatim}
\end{figure}


\subsection{发送消息}
当图片发送完成后，服务器端发送一个xmpp消息，其中的body内容格式为：

\begin{verbatim}
[img:$id]$desc

比如上面的图片发送成功后，发送消息"[img:502fd10abe4b19ed48000002]"。其中$desc是可选的图片说明文字。
\end{verbatim}

\subsection{在聊天室收到消息后获取图片}

接收端收到消息后，判断body的内容是否符合图片消息的格式。如果符合就调用下面的接口获取图片。

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/photos/show} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
  \hline
 id  & 字符串 & 必须 & 图片id\\
\hline
 size  & 整数 & 可选 &  目前0代表原图；2代表thumb2缩略图，大小为200*200。默认为2。\\ 
\hline
\end{tabular}
   \end{center}
\end{table}

聊天室里发图不需要发送已读回执消息。




\section{个人聊天时发图}

\subsection{个人聊天时上传图片}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/photo2s/create} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 photo[img]  & file & 必须 &  头像文件\\
 \hline
 photo[to\_uid]  & 字符串 & 必须 &  接收人的id\\
\hline
\end{tabular}
   \end{center}
\end{table}


\subsection{发送消息}
当图片发送完成后，服务器端发送一个xmpp消息，其中的body内容格式为：

\begin{verbatim}
[img:$id]

\end{verbatim}

\subsection{在个人聊天时收到消息后获取图片}
\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/photo2s/show} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
  \hline
 id  & 字符串 & 必须 & 图片id\\
\hline
 size  & 整数 & 可选 &  目前0代表原图；2代表thumb2缩略图，大小为200*200。默认为2。\\ 
\hline
\end{tabular}
   \end{center}
\end{table}

注意：聊天时发图，取消的100*100大小的缩略图。［2012-11-7］


\subsection{消息状态}
和普通的文字消息一样，接收者收到图片后发送状态更新消息（收到／已读）给发送者。发送者将状态显示在图片旁边。






\section{优惠券}

\subsection{商家推送优惠券}
当用户使用脸脸时，比如签到／摇一摇等，可以收到商家推送过来的优惠券。优惠券也是一个xmpp消息，其中的body内容格式为：

\begin{verbatim}
[优惠券:$name:$shop:$id:$time]

 其中，name是优惠券的名称、shop是商家的名称，id是该优惠券的id，time是该张优惠券的下发时间。
 
 同一张id的优惠券，如果time不同的话，分开显示和使用。
 
 所有优惠券都统一显示在会话中的“优惠券”文件夹中。优惠券的消息状态和其他消息同样处理。
\end{verbatim}

\subsection{优惠券展示}
优惠券以图片的方式展示，由服务器端生成该图片。当用户进入优惠券文件夹查看优惠券时，调用下面的接口获得优惠券的图片。

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/coupons/img} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 \  id  & 字符串 & 必填 &  该优惠券的id  \\
\hline
 size  & 整数 & 可选 &  目前0代表原图(580, 224)；1代表缩略图，大小为(290,112)。默认为1。\\ 
\hline
\end{tabular}
   \end{center}
\end{table}



\subsection{优惠券使用}
目前，所有优惠券都只支持单次使用，使用后即过期。当用户确认使用优惠券时，调用如下的接口：
\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{/coupons/use} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 \  id  & 字符串 & 必填 &  该优惠券的id  \\
\hline
\end{tabular}
   \end{center}
\end{table}


\section{XMPP服务器的Web接口}




\subsection{获得聊天室的消息历史记录}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://xmpp\_ip:5280/api/gchat} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 \  room  & 字符串 & 必填 &  聊天室的房间id  \\
\hline
\end{tabular}
   \end{center}
\end{table}


\subsection{获得个人聊天的历史记录}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://xmpp\_ip:5280/api/chat} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 \  uid  & 字符串 & 必填 &  用户的id  \\
\hline
\end{tabular}
   \end{center}
\end{table}

\subsection{获得两人之间的聊天历史记录}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://xmpp\_ip:5280/api/chat2} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 \  uid1  & 字符串 & 必填 &  用户1的id  \\
\hline
 \  uid2  & 字符串 & 必填 &  用户2的id  \\
\hline
\end{tabular}
   \end{center}
\end{table}

\subsection{其它内部接口}
仅用于服务器端的后台内部调用。

\subsubsection{给指定的聊天室发送消息}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://xmpp\_ip:5280/api/room} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 \  roomid  & 字符串 & 必填 &  聊天室的房间id  \\
\hline
 \  message  & 字符串 & 必填 &  需要发送的消息  \\
\hline
 \  uid  & 字符串 & 必填 &  该优惠券的id  \\
\hline
\end{tabular}
   \end{center}
\end{table}

\subsubsection{用户屏蔽通讯}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://xmpp\_ip:5280/api/block} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 \  uid  & 字符串 & 必填 &  发起屏蔽请求的用户的id  \\
\hline
 \  bid  & 字符串 & 必填 &  被屏蔽的用户的id  \\
\hline
\end{tabular}
   \end{center}
\end{table}

\subsubsection{用户解除屏蔽}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://xmpp\_ip:5280/api/unblock} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 \  uid  & 字符串 & 必填 &  发起解除屏蔽请求的用户的id  \\
\hline
 \  bid  & 字符串 & 必填 &  被屏蔽的用户的id  \\
\hline
\end{tabular}
   \end{center}
\end{table}

\subsubsection{发送任意XMPP消息}

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
\multicolumn{4}{|c|}{http://xmpp\_ip:5280/rest} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
\end{tabular}
   \end{center}
\end{table}

通过POST提交任意类型的XMPP文本消息。


\section{关于Push消息}

\subsection{登录Xmpp服务器时，报告设备的Push消息token}
登录Xmpp服务器，发送的密码格式变更为：

\begin{verbatim}
“用户密码”+《状态码》+token

状态码为：1代表ios开发设备，2代表实际的发布设备。
token是一个64位的字符串。

比如某用户的密码是“c53b2f16a24c61d9”，
token是“ea6e4f05b48f4a057816956e567c6feacf14ee28cbbbab67993e263c3dfa2c27”，
目前是进行开发测试，那么登录Xmpp服务器时的密码为：
“c53b2f16a24c61d91ea6e4f05b48f4a057816956e567c6feacf14ee28cbbbab67993e263c3dfa2c27”。
\end{verbatim}

服务器端解析出状态码和token并保存。


\subsection{退出时，报告设备的Push消息token}

用户退出的API接口新增pushtoken参数，以取消Push消息token绑定。

\subsection{Push消息的发送}
当有离线消息产生时，xmpp服务器获得用户的状态码以决定给那个Apple Push服务器发消息，以及获得和该用户绑定的token。一个用户只能绑定一个token。


\section{关于程序各页面之间的切换规则}

程序的首页是选择现场页面。现场则是一个聊天室页面。

1、程序干净启动时，要判断用户是否处于登录状态。

1.1如果已经登录，进入定位页面，并从服务器端获取新的商家列表。

1.2如果没有登录，进入登录页面。


2、程序从睡眠状态被激活时，要判断距离上次的运行时间。

2.1 如果不足12个小时，上次被任务切换时停留在那个页面就仍然停留在该页面。

2.2 如果超过12个小时，进入定位页面，并从服务器端获取新的商家列表。



4、从其它tab点击现场时，判断用户是否摇进过现场

4.1 如果摇进过某个现场，直接进入该现场聊天室。。

4.2 如果没有摇，那么就是定位页面。




\newpage


\end{document}
