\section{XMPP协议接口}


\subsection{与Openfire聊天服务器接口}
脸脸网的XMPP服务器采用的是Openfire。

\begin{enumerate}
\item 脸脸网的用户id加上"@dface.cn"就是openfire的jid，两个系统的密码一致。登录xmpp时的resource使用机器特定的字符串，以区分一个帐号在多台设备上登录。
\item 商家的id加上"@c.dface.cn"就是现场聊天室的jid。
\item 脸脸的用户名就是openfire的用户名，且也就是聊天时的用户名。Xmpp协议允许用户在加入聊天室时取一个名字，脸脸的聊天室应该忽略该名字。脸脸用户加入聊天室的时候，其jid格式为"roomid@c.dface.cn/uid"。
\item 脸脸中的关注和粉丝关系是单向的，和xmpp中的好友roster关系无关。
\item 只要用户登录，其xmpp协议中的presence就是在线，没有其它状态。
\item 聊天室中，消息id以ckn开头的消息代表是用户首次进入聊天室发送的通知类消息，客户端根据这个ckn头确定是否有新的人进入了聊天室。
\item 脸脸中的隐身也和xmpp中的隐身状态无关。
\item xmpp中的任意两个用户可以发送消息，不管对方是否隐身，只要对方未设置黑名单即可。如果对方未登录，那么就是离线消息。
\end{enumerate}

所有的消息（包括单聊和聊天室），要保证消息id的唯一性，建议使用uuid生成消息的id。客户端发送的消息，由客户端生成这个id；服务器端发送的消息，由服务器端生成这个id。

目前，在发图的时候，存在同时收到两张一样的图片的消息的BUG。为了处理这个BUG，客户端在收到图片消息时，如果消息的图片ID一样，不重复显示图片。但是图片id以faq开头的图片消息不需要判断图片id重复的问题。



\subsection{脸脸中的聊天用户的三种类型}

\begin{enumerate}
\item管理员，其jid固定为"502e6303421aa918ba000001@dface.cn";
\item商家，其jid为's+商家id@dface.cn';
\item个人，其jid为'个人id@dface.cn'。
\end{enumerate}
如果一个jid以字母s开头，那么它一定是商家。


\subsection{摇一摇及其消息格式}
目前，用户在聊天室摇一摇时，客户端发送“用户名 摇了摇手机和大家say hello~”给服务器。这导致要分析摇一摇数据很困难，所以要为摇一摇定义特殊的消息格式。

\begin{verbatim}
摇一摇的消息格式为：
 [摇一摇:$name]

其它客户端收到摇一摇的消息后，再将其转换为文字描述。
\end{verbatim}



\subsection{个人之间聊天的消息发送状态确认}
XMPP协议的消息发送状态确认参考规范“\href{http://xmpp.org/extensions/xep-0022.html}{XEP-0022: Message Events}”。其定义了四种消息事件：Offline、Delivered、Displayed、Composing。Dface只需要其中的两种。

\begin{verbatim}
当接收端收到消息时，发送delivered确认消息，例如：
<message id="Kk98S-16" to="s6@dface.cn/ylt">
<x xmlns="jabber:x:event"><delivered/><id>purplea5e6669c</id></x>
</message>

当接收端展示消息时，发送displayed确认消息，例如：
<message id="Kk98S-17" to="s6@dface.cn/ylt">
<x xmlns="jabber:x:event"><displayed/><id>purplea5e6669c</id></x>
</message>

发送端根据从接收端获得的状态通知更改单条消息的发送状态。

只有类型是message,且body不为空的消息需要确认状态。照片提醒消息（发送人是"sphoto@dface.cn"）不需要确认状态。

当本地无法发送消息时（比如无网络、或者连接不上xmpp服务器），消息的状态为“发送失败”。发送失败的消息可以再次发送。

\end{verbatim}

\subsection{消息提醒}
\begin{enumerate}
\item 当不在现场的界面收到现场聊天室的消息时，在现场按钮旁边加红点提醒;
\item 当收到发送人是"sphoto@dface.cn"发过来的单聊消息时，表明是有照片提醒消息。这时在我的照片等地方加红点提醒。
\item 状态确认类消息不需要提醒。
\item 其它个人之间聊天的消息以数字计数的方式提醒。
\end{enumerate}


\subsection{关于照片的类型}
聊天相关的照片本来分为两种：单聊的照片和聊天室的照片。分别通过photos和photo2s接口获取。但是后来增加了问答类的图片消息和单聊时的群聊照片提醒/个人头像推送。所以为了区分这几种照片，规定如下：
\begin{enumerate}
\item 在聊天室收到id以“faq”开头的图片消息，说明是问答类的图片消息 ，查看调用photos/show接口；
\item在单聊时收到id以“U”开头的图片消息，说明是个人单聊的图片消息，查看调用photo2s/show接口;
\item在单聊时收到id以“Logo”开头的图片消息，说明是个人头像消息，查看调用photo2s/show接口;
\item收到的其它图片消息都是聊天室的照片，包括在聊天室发的照片以及将该照片转发给个人。这类消息查看可以调用photos/show接口，也可以调用photo2s/show接口。但是这类照片还可以点评。点评时获取照片详情的接口则必须是photo/detail接口。
\end{enumerate}

不管是在单聊和群聊时，图片消息仅仅根据图片id即可判断出类别。


\input{./photo.tex}


\section{优惠券}

\subsection{商家推送优惠券}
当用户使用脸脸时，比如签到／摇一摇等，可以收到商家推送过来的优惠券。优惠券也是一个xmpp消息，其中的body内容格式为：

\begin{verbatim}
[优惠券:$name:$shop:$id:$time:$hint]

 其中，name是优惠券的名称、shop是商家的名称，id是该优惠券的id，time是该张优惠券的下发时间。
 
 hint是可选的，表示使用优惠券时的提示语言，比如“请输入此次的消费金额”。有hint的优惠券使用时要求用户输入内容才能使用优惠券。内容默认是数字。
 
优惠券id不重复。如果有重复的优惠券id时代表消息重发了，此时要忽略这条消息。
 
 所有优惠券都统一显示在会话中的“优惠券”文件夹中。优惠券的消息状态和其他消息同样处理。
\end{verbatim}

\subsection{优惠券展示}
优惠券以图片的方式展示，由服务器端生成该图片。当用户进入优惠券文件夹查看优惠券时，调用下面的接口获得优惠券的图片。

\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
GET & \multicolumn{3}{|c|}{/coupons/img} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 \  id  & 字符串 & 必填 &  该优惠券的id  \\
\hline
 size  & 整数 & 可选 &  目前0代表原图(580, 224)；1代表缩略图，大小为(290,112)。默认为1。\\ 
\hline
\end{tabular}
   \end{center}
\end{table}



\subsection{批量获取优惠券详细信息}
目前优惠券详细信息里只有经纬度这一个信息，以后可能扩展其它信息。
\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
GET & \multicolumn{3}{|c|}{/coupons/info} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 \  ids  & 字符串 & 必填 &  要获取的优惠券的id，多个id以英文","分割  \\
 \hline
\end{tabular}
   \end{center}
\end{table}

优惠券的经纬度主要用于优惠券的排序，以实现快速找到前所在的商家的优惠券。

优惠券的排序规则为：没有看过的新优惠券在前，看过的优惠在后，用过的在最后。没看过的优惠券，没有获得经纬度信息的距离算作0。同种状态的优惠券，距离当前位置小的在前，大的在后。

每次进入优惠券文件夹排序一次，在操作过程中不改变排序。比如查看／使用了优惠券，不改变这个优惠券的位置。只有在下次重新进入的时候，才改变位置。

例子：

\begin{figure}[H]
\begin{verbatim}
访问：/coupons/info?ids=518de040c90d8be6840000b5,5171d8d7c90d8b3c2900004a
返回值：

[
{"id":"518de040c90d8be6840000b5","loc":[30.2425077887959,120.15320074395899]},
{"id":"5171d8d7c90d8b3c2900004a","loc":[30.282349,120.117012]}]


\end{verbatim}
\end{figure}







\subsection{优惠券使用}
目前，所有优惠券都只支持单次使用，使用后即过期。当用户确认使用优惠券时，调用如下的接口：
\begin{table}[H]
   \begin{center}
\begin{tabular}{|c|c|c|p{12cm}|}
\hline
POST & \multicolumn{3}{|c|}{/coupons/use} \\
\hline\hline
 \  参数  & 类型 & 必填 &  说明  \\
\hline
 \  id  & 字符串 & 必填 &  该优惠券的id  \\
 \hline
 \  data  & 字符串 & 可选 &  优惠券使用时填写的信息  \\
\hline
\end{tabular}
   \end{center}
\end{table}

优惠券的使用要保证只能点击一次，使用后就灰掉，不需要等待服务器端的返回结果。如果网络不通或者服务器端失败，要以一定的策略重试。

当优惠券有hint字段时，使用时带上消费者输入的data。


在聊天室收到的id以“coupon”开头的消息时，点击该消息要能跳转到优惠券文件夹。

\input{./xmpp_web.tex}


\section{关于Push消息}

\subsection{登录Xmpp服务器时，报告设备的Push消息token}
登录Xmpp服务器，发送的密码格式变更为：

\begin{verbatim}
“用户密码”+《状态码》+token

状态码为：1代表ios开发设备，2代表实际的发布设备。
token是一个64位的字符串。

比如某用户的密码是“c53b2f16a24c61d9”，
token是“ea6e4f05b48f4a057816956e567c6feacf14ee28cbbbab67993e263c3dfa2c27”，
目前是进行开发测试，那么登录Xmpp服务器时的密码为：
“c53b2f16a24c61d91ea6e4f05b48f4a057816956e567c6feacf14ee28cbbbab67993e263c3dfa2c27”。
\end{verbatim}

服务器端解析出状态码和token并保存。


\subsection{退出时，报告设备的Push消息token}

用户退出的API接口新增pushtoken参数，以取消Push消息token绑定。

\subsection{Push消息的发送}
当有离线消息产生时，xmpp服务器获得用户的状态码以决定给那个Apple Push服务器发消息，以及获得和该用户绑定的token。一个用户只能绑定一个token。
