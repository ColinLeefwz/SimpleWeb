<!DOCTYPE html>
<html>
	<head>
        <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1"> 
                <title>脸脸</title> 

                <link rel="stylesheet"  href="css/themes/default/jquery.mobile.css" />  
                <link rel="stylesheet" href="_assets/css/jqm-docs.css"/>
                
                <script src="js/jquery.js"></script>
                <script src="_assets/js/jqm-docs.js"></script>
                <script src="js/jquery.mobile.docs.js"></script>
                
                <script type="text/javascript" charset="utf-8" src="cordova-1.7.0.js"></script>
                <script type="text/javascript" charset="utf-8" src="y1y.js"></script>
                
                <script type="text/javascript">
var shops = [{"name":"新紫轩花店","address":"文一路266号","created_at":"2012-03-06T18:34:43+08:00","linkman":"","updated_at":"2012-03-06T19:10:48+08:00","dp_id":5097101,"fullname":"","lng":120.12763,"kb_id":"","id":40056,"phone":"","lat":30.28691}];                    
                    
  
                    function rad(d)
                    {
                        return d * Math.PI / 180.0;
                    }
                    
                    function GetDistance( lat1,  lng1,  lat2,  lng2)
                    {
                        //alert(lat1+", "+lng1+", "+lat2+", "+lng2);
                        var radLat1 = rad(lat1);
                        var radLat2 = rad(lat2);
                        var a = radLat1 - radLat2;
                        var  b = rad(lng1) - rad(lng2);
                        var s = 2 * Math.asin(Math.sqrt(Math.pow(Math.sin(a/2),2) +
                                                        Math.cos(radLat1)*Math.cos(radLat2)*Math.pow(Math.sin(b/2),2)));
                        s = s *6378.137 ;// EARTH_RADIUS;
                        s = Math.round(s * 10000) / 10;
                        return s;
                    }
                    
                    var lat_cur=null, lng_cur=null;
                    
                    function aroundme(){	
                        var url2="http://www.dface.cn/aroundme/mapabc?count=100&lat="+lat_cur+"&lng="+lng_cur;
                        //alert(url2);
                        console.log(url2);
                        get_shops_around_me(url2);
                    }
                    
                    function get_shops_around_me(url2){
                        var jqxhr = $.ajax({
                                           type: 'GET',
                                           url: url2,
                                           dataType: "json"
                                           })
                        .success(function(data, textStatus, jqXHR) { 
                                 sessionStorage.setItem("cur_shops",jqXHR.responseText);
                                 //alert(data[0].name);
                                 if(data.length>0) shops=data;
                                 for(var i=0;i<shops.length;i++){
                                 shops[i].diff=GetDistance(lat_cur,lng_cur,shops[i].lat,shops[i].lng);
                                 }
                                 $( "#shopTemplate" ).tmpl( shops ).appendTo( "#shopList" );
                                 $("#map_button").show();
                                 })
                        .fail(function(jqXHR0, textStatus) {
                              alert( "获取商家信息失败!"+ textStatus);
                              });
                    }
                    
                    function onBodyLoad(){		
                        document.addEventListener("deviceready", device_ready, false);
                    }
                    function show_gps_info(position){
                        alert('Latitude: '          + position.coords.latitude          + '\n' +
                              'Longitude: '         + position.coords.longitude         + '\n' +
                              'Altitude: '          + position.coords.altitude          + '\n' +
                              'Accuracy: '          + position.coords.accuracy          + '\n' +
                              'Altitude Accuracy: ' + position.coords.altitudeAccuracy  + '\n' +
                              'Heading: '           + position.coords.heading           + '\n' +
                              'Speed: '             + position.coords.speed             + '\n' +
                              'Timestamp: '         + new Date(position.timestamp)      + '\n');
                    }
                    var onSuccess = function(position) {
                        //show_gps_info(position);
                        lat_cur = position.coords.latitude;
                        lng_cur = position.coords.longitude;
                        acc_cur = position.coords.accuracy;
                        sessionStorage.setItem("lat_cur",lat_cur);
                        sessionStorage.setItem("lng_cur",lng_cur);
                        sessionStorage.setItem("acc_cur",acc_cur);
                        $("#gps_lat").html(lat_cur);
                        $("#gps_lng").html(lng_cur);
                        $("#gps_diff").html(position.coords.accuracy);
                        //aroundme();
                    };
                    function onError(error) {
                        alert('code: '    + error.code    + '\n' +
                              'message: ' + error.message + '\n');
                    }     
                    function load_js(url){
                        var oHead = document.getElementsByTagName('HEAD').item(0); 
                        var oScript= document.createElement("script"); 
                        oScript.type = "text/javascript"; 
                        oScript.src=url; 
                        oHead.appendChild( oScript); 
                    }
                    function get_gps_location(){
                        navigator.geolocation.getCurrentPosition(onSuccess, onError,
                                                                 { enableHighAccuracy: true });
                    }
                    function device_ready(){
                        get_gps_location();
                        acc_startWatch(yaole);
                        load_js("jquery.tmpl.js");
                        
                    }
                    
                    function show_map(){
                        $("#map_canvas").show();
                        initialize(lat_cur,lng_cur);
                        initialize_marker(lat_cur,lng_cur);
                    }
                    
                    function yaole(){
                        if(lat_cur==null){
                            alert("无法定位当前位置，请稍后再摇！");
                            return false;
                        }
                        //$("#yy")[0].src="wait (2).gif";
                        document.getElementById("yy").src="./wait.gif"
                        my_media = new Media("./sent.mp3");
                        my_media.play();
                        aroundme();
                        return true;
                    }
                    
                    function check_in(shop_name,shop_id){
						if(!confirm("你确定在"+shop_name+"("+shop_id+")签到吗？")) return;
                        check_in_done(shop_name,shop_id);
                    }
 
                    function check_in2(){
						var shop_name = prompt('商家名称：');
                        if(shop_name!=null) check_in_done(shop_name);
                    }
                    
                    function check_in_done(shop_name,shop_id){
                        var url_checkin = 'http://www.dface.cn/checkins.json?user_id=1&mshop_id='+shop_id+'&shop_name='+shop_name+'&lat='+lat_cur+'&lng='+lng_cur+'&accuracy='+acc_cur;
                        console.log(url_checkin);
                        //alert(url_checkin);
                        var jqxhr = $.ajax({
                                           type: 'POST',
                                           url: url_checkin,
                                           dataType: "json"
                                           })
                        .success(function(data, textStatus, jqXHR) { 
                                 alert("签到成功！");
                                 })
                        .fail(function(jqXHR0, textStatus) {
                              alert( "签到失败!"+ textStatus);
                              });
                    }
                    
                    
                    </script>     
    </head> 
    <body onload="onBodyLoad()"> 
        
        <div data-role="page" class="type-interior">
            
            <div data-role="header" data-theme="f">
                <h1>Mapabc</h1>
                <a href="#" onclick="aroundme();" data-role="button">获取</a>
                <a id="map_button" href="map.htm" style="display:none">地图</a>
            </div><!-- /header -->
            
            <div data-role="content">
                <div class="content-primary">
                    当前位置：经度<span id="gps_lat"></span>,纬度<span id="gps_lng"></span>, 误差：<span id="gps_diff"></span>米 <a onclick="get_gps_location();">刷新</a> &nbsp; 
                    
                    <ul data-role="listview" id="shopList">
                        <script id="shopTemplate" type="text/x-jquery-tmpl">
                            <li data-corners="false" data-shadow="false" data-iconshadow="true" data-inline="false" data-wrapperels="div" data-icon="arrow-r" data-iconpos="right" data-theme="c" class="ui-btn ui-btn-up-c ui-btn-icon-right ui-li-has-arrow ui-li"><div class="ui-btn-inner ui-li"><div class="ui-btn-text"><a href="#" onclick="return false;check_in(this.firstChild.innerText,this.firstChild.nextSibling.innerText)" class="ui-link-inherit"><span>${name}</span><span style="display:none">${id}</span> ${diff}米</a></div><span class="ui-icon ui-icon-arrow-r ui-icon-shadow"></span></div></li>
                         </script>
                    </ul>
                </div><!--/content-primary -->		

                <div>
                    <br>
                    <img id="yy" src="y1y.png" onclick="document.location='./acc2.htm';"/>
                    <br>
                    <center>摇一摇，查看附近的商家</center>
                    <br>
                </div>               
            </div><!-- /content -->
            
            <div data-role="footer" class="footer-docs" data-theme="c">
				<p onclick="document.location='./index2.html';">&copy; Copyright 2011-2012 脸脸</p>
                <p>
                <br><br><br><br><br><br>
                </p>
            </div>
            
		</div><!-- /page -->
        
        
    </body>
</html>

