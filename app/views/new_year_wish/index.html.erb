<!DOCTYPE>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=0.5, user-scalable=0, minimum-scale=0.5, maximum-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-itunes-app" content="app-id=577710538,app-argument=dface://login/" />
  <meta http-equiv="mobile-agent" content="format=xhtml; url=http://dface.cn/mini.html" />
  <title>元旦活动<%= @remote_ip %></title>
  <link rel="stylesheet" href="/nyd/css/public.css" type="text/css" media="screen"/>
  <script src="/nyd/js/jquery-1.6.2.min.js" language="javascript" type="text/javascript"></script>
  <style type="text/css">
    .plane4 .hide { display: none; }
    #More, #PicBox { display: none; }
  </style>
</head>
<body>
  <div class="main">
    <a id="BG">谢谢<img src="/w/1/images/sign2.png"/>收到你的祝福啦<img src="/w/1/images/sign3.png"/></a>
    <div class="con">
      <div class="imgsbox">
        <!--<img class="imgs" src="/nyd/images/pic7.jpg">-->
        <%= image_tag "http://s.dface.cn/nyd#{@wish.photo.nyd_img_url}.jpg" , :class => "imgs" %>
        <div class="imgs2">
          <img src="/nyd/images/pic1_01.jpg" class="block">
          <img src="/nyd/images/pic1_02.png" class="l">
          <img src="/nyd/images/pic1_03.jpg" class="r">
          <img src="/nyd/images/pic1_04.jpg" class="block">
        </div>
        <div class="imgs2 none">
          <img src="/nyd/images/pic2_01.jpg" class="block">
          <img src="/nyd/images/pic2_02.png" class="l">
          <img src="/nyd/images/pic2_03.jpg" class="r">
          <img src="/nyd/images/pic2_04.jpg" class="block">
        </div>
        <div class="imgs2 none">
          <img src="/nyd/images/pic3_01.jpg" class="block">
          <img src="/nyd/images/pic3_02.png" class="l">
          <img src="/nyd/images/pic3_03.jpg" class="r">
          <img src="/nyd/images/pic3_04.jpg" class="block">
        </div>
        <div class="imgs2 none">
          <img src="/nyd/images/pic4_01.jpg" class="block">
          <img src="/nyd/images/pic4_02.png" class="l">
          <img src="/nyd/images/pic4_03.jpg" class="r">
          <img src="/nyd/images/pic4_04.jpg" class="block">
        </div>
        <div class="imgs2 none">
          <img src="/nyd/images/pic5_01.jpg" class="block">
          <img src="/nyd/images/pic5_02.png" class="l">
          <img src="/nyd/images/pic5_03.jpg" class="r">
          <img src="/nyd/images/pic5_04.jpg" class="block">
        </div>
        <img class="imgs3" src="/nyd/images/pic6.png">
      </div>
      <div class="plane">
        <div class="content">
          <div class="tit">
            <%= image_tag @wish.user_logo, :align => "absbottom" %>
            <h2><a><%= @wish.photo_user.try(:name) %></a>的心愿：</h2>
          </div>
          <p><%= @wish.photo_desc %></p>
        </div>
      </div>
      <div class="clear1"></div>
      <div class="plane7" id="PicBox">
        <img rel="0" src="/nyd/images/p1.png">
        <img rel="1" src="/nyd/images/p2.png">
        <img rel="2" src="/nyd/images/p3.png">
        <img rel="3" src="/nyd/images/p4.png">
        <img rel="4" src="/nyd/images/p5.png">
      </div>
      <div class="plane3">
        <a name="a1"></a>
        <div class="l">我已经收到
          <span class="pink"><%= @wish.total %></span>个祝福啦
          <a href="/nyd/rule.html" target="_blank" class="f20">（活动详情）</a><br>
          <%if @wish.total.to_i < 30 %>
          <span class="pink">
            还差<%= (30 - @wish.total.to_i) < 0 ? 0: (30- @wish.total.to_i)%>个祝福就有机会拿到1000元新年红包啦，<br/>
            赶紧祝福我噢~
          </span>
          <%else%>
          <span class="pink">你的人气爆棚！30个祝福已经集满！正式加入千元红包抢夺大军啦！祝福越多，中奖几率越高噢😉</span>
          <%end%> 
        </div>
      </div>
      <div class="plane4">
        <ul id="Mes">
          <% @wish.data.reverse.each do |data| %>
            <li class="hide"><a><%= data.join(': ') %></a></li>
          <% end %>
        </ul>
        <div class="clear1"></div>
        <a class="r mr30 pointer" id="More">查看更多</a>
      </div>
      <div class="plane5">
        <div class="title1">祝福TA：</div>
        <%= hidden_field_tag :id, params[:id], id: "wish_id" %>
        <div class="inputbox1">
          <%= text_field_tag :name, params[:name] ||'祝福人', class: "texts" %>
        </div>
        <div class="inputbox2">
          <%= text_area_tag :wish, params[:wish] || '祝福语'%>
        </div>
        <div class="clear1"></div>
        <a id="Btn" class="btn r mb30" href="#a1"></a>
      </div>
      <a target="_blank" href="http://www.dface.cn/mini.html" class="btn2"></a>
      <div class="plane6">
        <a href="http://www.dface.cn/mini.html" target="_blank">
          <img src="/nyd/images/logo.png">
        </a>
      </div>
    </div>
  </div>
  <script>
  var name_list = ['梦露', '金正恩', '习近平', '赫本', '奥巴马'];
  var uid = null;
  var sid = null;

  function dface_init(sid,uid) {
    sid = sid;
    uid = uid;
    var user = "<%= @wish.photo_user.id %>";
    if (uid == user ) {
      $("#PicBox").show();
    };
  }

  function check_login_user(){
    $.get('/new_year_wish/check_login_user', {
      id: $("#wish_id").val(), 
      sid: sid, 
      uid: uid
    }, function(data){
      if (data == true) {
        $("#PicBox").show();
      };
    });
  }

  $(document).ready(function(){

    var wish_size = $("#Mes li").size();
    if (wish_size > 20) {
      $("#More").show();
    };
    $("#Mes li.hide:lt(20)").removeClass("hide");

    $("#More").click(function(){
      $("#Mes li.hide:lt(20)").removeClass("hide");
      if ($("#Mes li.hide").size == 0) {
        $("#More").hide();
      };
    });

    $("#name").click(function(){
      if($(this).val()=="祝福人"){
        $(this).val("");
      }
    });

    $("#wish").click(function(){
      if($(this).val()=="祝福语"){
        $(this).val("");
      }
    });

    $("#PicBox img").click(function(){
      var n=$(this).attr("rel");
      $(".imgs2").addClass("none");
      $(".imgs2").eq(n).removeClass("none");
      $(".btn2").text("我也要" + name_list[n] + "的祝福~");
      $.post("/new_year_wish/update", {
        template: n, 
        id: $("#wish_id").val(), 
        uid: uid
      }, function(){
      });
    });
    var select = <%= @wish.template || 0 %>;
    $(".imgs2").addClass("none");
    $(".imgs2").eq(select).removeClass("none");
    $(".btn2").text("我也要" + name_list[select] + "的祝福~");
  });

  var timer=timer2=timer3=1;
  $("#Btn").click(function(){
    var n=$("#name").val(), w=$("#wish").val();
    if(n==""||n=="祝福人"||w==""||w=="祝福语"){
      return false;
    }

    $.get("/new_year_wish/create",{name: n, wish: w, id: $("#wish_id").val()}, function(data){
      if (data["error"] == 1 ) {
        alert(data["message"]);
        return;
      };
      var i=0;
      
      $("#Mes li").removeClass("new");
      $("#Mes li a").removeAttr("style");
      
      var mes = "<li class='new'><a>" + n + "：" + data["message"] + "</a></li>";
      $("#Mes").prepend(mes);
      $("#name").val("祝福人"); 
      $("#wish").val("祝福语");
      
      clearInterval(timer);
      clearTimeout(timer2);
      clearTimeout(timer3);

      timer2=setTimeout(function(){
        var bghigh=$(document).scrollTop()+($(window).height()-160)/2;
        var bgleft=$(document).scrollLeft()+($(window).width()-450)/2;
        $("#BG").css({"top":bghigh+"px","left":bgleft+"px"});
        $("#BG").fadeIn(500);
      },250);
      
      timer3=setTimeout(function(){
        $("#BG").fadeOut(500);
      },3000);
      
      timer=setInterval(function(){
        switch(i){
          case 0: $("#Mes li.new a").css({"color":"#FF1E1E","font-size":"30px"});break;
          case 1: $("#Mes li.new a").css({"color":"#3232FF","font-size":"30px"});break;
          case 2: $("#Mes li.new a").css({"color":"#bbb","font-size":"30px"});i=-1;break;
        }
        i++;
      },1000);
    });
  });
$("#BG").click(function(){
  $("#BG").fadeOut(500);
});
</script>
<iframe src="dface://init?mode=1" style="display:none" />
</body>
</html>

