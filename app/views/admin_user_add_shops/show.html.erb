<%= javascript_include_tag "jquery-1.6.2.min.js" %>
<%= javascript_include_tag "jquery.form.js" %>
<script type="text/javascript">
  function ajaxDis(lob1){
    var lob2 = $('#lob2').val();
    $.get('/admin_user_add_shops/ajax_dis', {lob1: lob1, lob2: lob2}, function(data){
      $('#dis').replaceWith("<span id='dis'>两经纬度之间相距"+data["distance"]+'（米）</span>')
    })
  }


  $(document).ready(function()
  {
    $.get('/admin_user_add_shops/near?id=<%= @shop.id.to_i %>', function(data){
      if(data=='')
      {str = '<h3>附近没有重复的商家.</h3>'}
      else{
        str = "<table><tr><th>id</th><th>名称</th><th>地址</th><th>分类</th><th>距离</th></tr>"
        data.forEach(function(s){
          str += "<tr><td>" +s.join("</td><td>") + "</td></tr>"
        })
        str += "</table>"}
      $('#nearShops').replaceWith(str)
    })

    $('#shopFrom').hide();

    $('#cedit').click(function(){
      $("#shopFrom").show();
      $('#showShop').hide();
    });

    $('#sig').click(function(){
      if(confirm("确定忽略？"))
        $.ajax({url: "/admin_user_add_shops/ignore",
          type: 'get',
          data: {id: <%= @shop.id.to_i %>},
          dataType:'script',
          success: function(){window.close();}
        })
    });

    $('#sdel').click(function(){
      $.get("/admin_user_add_shops/ajax_del?id=<%= @shop.id.to_i %>", function(){
        window.close();
      })
    });
    
    $('#shopFrom').submit(function()
    {
      var options = {
        url:'/admin_user_add_shops/update',
        type:'POST',
        success: function(data){
          $('#sname').replaceWith("<span id='sname'>" + data['name'] +'</span>');
          $('#saddr').replaceWith("<span id='saddr'>" + data['addr'] +'</span>');
          $('#st').replaceWith("<span id= 'st' >" + data['st'] +'</span>');
          $('#slob').replaceWith("<span id= 'slob'>" + data['lob'] +'</span>');
          $('#slo').replaceWith("<span id='slo'>" + data['lo'] +'</span>');
          $("#shopFrom").hide();
          $('#showShop').show();
          $('#wclose').show();
        }
      }
      $('#shopFrom').ajaxSubmit(options);
      return false;
    })
  }
)
</script>
<h1>商家处理</h1>

<p>
  <span style="padding: 0 5px;"> <%= link_to '去百度地图查看',"http://api.map.baidu.com/lbsapi/getpoint/index.html", :target => "blan" %> </span>
  <span style="padding: 0 5px;"><%= link_to '编辑',"#" ,:id => 'cedit'%></span>
  <span style="padding: 0 5px;"><%= link_to '标记删除',"#", :id => 'sdel'%></span>
  <span style="padding: 0 5px;"><%= link_to '忽略',"#", :id => 'sig'%></span>
  <a id="wclose" style="display:none" href="#" onclick="window.opener.rmshop('<%=@shop.id.to_i%>');window.close();">关闭当前窗口</a>
</p>
<p>

  <%= form_tag "/admin_user_add_shops/send_chat" do %>
    <%= hidden_field_tag :to_uid, @shop.creator %>
    发送消息： <%= text_field_tag :text %>
    <%= submit_tag '发送' %>
  <% end  %>
</p>
<div id="showShop">
  <p>
    <b>商家id:</b>
    <%= @shop.id.to_i %>
  </p>
  <p>
    <b>商家名称:</b>
    <span id="sname">
      <%= @shop.name %>
    </span>
  </p>
  <p>
    <b>区号:</b>
    <%= @shop.city %>
  </p>
  <p>
    <b>电话:</b>
    <%= @shop.tel %>
  </p>
  <p>
    <b>创建者:</b>
    <%= @shop.user.try(:name) %>
    <b>签到次数:</b>
    <%=link_to @shop.user.checkins.count,"/admin_checkins?uid=#{@shop.user.id}", :target => 'check' %>
  </p>

  <p>
    <b>实际经纬度:</b>
    <span id="slo">
      <%= @shop.lo %>

    </span>
  </p>
  <div id="nearShops">
    正在获取附近相似商家...
  </div>
  <p>
    <b>百度经纬度:</b>
    <span id="slob">
      <%= @shop.lob %>
      <input type="text" id="lob2"/>
      <a onclick="ajaxDis('<%= @shop.lob %>')">计算距离</a>
      <span id="dis">
      </span>
    </span>
  </p>
  <p>
    <b>地址:</b>
    <span id="saddr">
      <%= @shop.addr %>
    </span>
  </p>
  <p>
    <b>类型:</b>
    <span id="st">
      <%= @shop.show_t %>
    </span>
  </p>
</div>



<%= form_for(@shop, :url => '',:html => {:id => 'shopFrom'}) do |f| %>
  <%= hidden_field_tag :id, @shop.id.to_i %>
  <p>
    名称:<br />
    <%= f.text_field :name %>
  </p>
  <p>
    地址:<br />
    <%= f.text_field :addr %>
  </p>
  <p>
    百度纬度度:<br />
    * 如果不需要修改经纬度,不用填入.<br />
    * 支持多百度坐标,分号隔开.例:120.108,30.28 或 120.108,30.28;121.108,31.28<br />
    <%= f.text_field :lob, :value => '' %>
  </p>
  <p>
    类型:<br />
    <%= f.select :t,options_for_select(import_t)  %>
  </p>

  <p>
    父商家id:<br />
    * 如果当前地点不是商家的子地点,不用填入.否则可以填入父商家的id.<br />
    <%= text_field_tag :pid  %>
  </p>
  <p>
    <%= f.submit "保存" %>
  </p>
<% end %>


