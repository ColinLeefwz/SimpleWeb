
<div class="con2">
  <div class="title1 mb30">
    <h2 class="f18 l">优惠券管理</h2>
    <a href="/shop3_coupons" class="r btn9">发布优惠券</a>
  </div>
  <div class="submenu">
    <ul>
      <li class="hover"><a href="/shop3_coupons/list">优惠券列表</a></li>
      <li><a href="/shop3_coupons/newly_down">最新下载记录</a></li>
      <li><a href="/shop3_coupons/newly_use">最新使用记录</a></li>
      <li><a href="/shop3_coupon_reports">统计报表</a></li>
    </ul>
    <div class="r">
    </div>
  </div>
  <table width="100%" cellpadding="0" cellspacing="0" class="tab2">
    <tr class="change" id="Tr0">
      <th class="textleft pl15">优惠券</th>
      <th width="80">已下载</th>
      <th width="80">已使用</th>
      <th width="45">状态</th>
      <th width="100">操作</th>
    </tr>


    <% @coupons.each do |coupon| %>
      <tr id="Tr1">
        <td>

          <%=link_to((image_tag(coupon.img.url(:t1)+"?t=#{Time.now}",:id=>"img_#{coupon.id}", :class=>"l #{coupon.hidden && 'imgfilter'}",:width => "130")), coupon.img.url,  :target => "blank#{coupon.id}") %>
          <a href="show?id=<%= coupon.id%>" title="查看详情"><span class="l ml10"><%= coupon.name %><br/><span class="gay1">（<%= coupon.show_t2  %>）</span></span></a>
        </td>
        <td width="80" class="textcenter"><%= link_to coupon.down_users.to_a.count, {:action => 'newly_down', :cid => coupon.id} %></td>
        <td width="80" class="textcenter"><%= link_to coupon.use_users.to_a.count,{:action => 'newly_use', :cid => coupon.id} %></td>
        <td width="45" class="textcenter"><%= coupon.hidden ? "已停用" : '有效' %></td>


        <td width="135" valign="middle" class="textcenter">

          

          <% if coupon.t2.to_i == 1 %>
            <%=link_to '编辑', ("edit?id=#{coupon.id}" if coupon.down_users.blank? && coupon.hidden !=1 ), :class => "edit",:title => "编辑"%>
          <% elsif coupon.t2.to_i == 2  %>

          <% end %>


          <% if coupon.hidden == 1 %>
            <%= link_to '激活', '#', :onclick => "ajaxActivate($(this), '#{coupon.id}', #{coupon.allow_activate?})", :class => "act", :title => "激活" %>
          <% else %>
            <%= link_to '停用', '#', :onclick => "ajaxDeply($(this), '#{coupon.id}')",:class => "act2",:title => "停用" %>
          <% end %>
          <%= (link_to '删除', '#', :onclick => "ajaxDel($(this), '#{coupon.id}')", :class => "del",:title => "删除") if coupon.down_users.blank?  %>

        </td>

      </tr>
    <% end %>

  </table>
  <div class="pagination">
    <%= generate_paginate.html_safe %>
  </div>

</div>


<style>
  <!--
  .imgfilter{ filter: grayscale(100%); -webkit-filter: grayscale(100%); -moz-filter: grayscale(100%); -ms-filter: grayscale(100%); -o-filter: grayscale(100%); filter: url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'grayscale\'><feColorMatrix type=\'matrix\' values=\'0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#grayscale"); filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale=1); -webkit-filter: grayscale(1);}
  -->
</style>


<script type ="text/javascript">
  
  $(document).ready(function(){
    $("#img_513d2f7b47bce5d705000001").click(function(){
      grayscale($(document));
    });
  });
  
  function ajaxDeply(obj, coupon_id){
    if(confirm("确定停用此优惠券么？"))
    {
      $.get("/shop3_coupons/ajax_deply",{id: coupon_id}, function(data) {
        obj.replaceWith(data['text']);
        $("#img_"+coupon_id).addClass("imgfilter");
      });
    }
  }

  function ajaxActivate(obj, coupon_id, allow){
    if(1){
      if(confirm("确定激活此优惠券么？"))
      {
        $.get("/shop3_coupons/ajax_activate",{id: coupon_id}, function(data) {
          obj.replaceWith(data['text']);
          $("#img_"+coupon_id).removeClass("imgfilter");
        });
      }
    }
    else
    {
      alert('不能激活,已有一张有效的同规则优惠券。')
    }
  }

  function ajaxDel(obj, coupon_id){
    if(confirm("确定删除此优惠券么？"))
    {
      $.get("/shop3_coupons/ajax_del",{id: coupon_id}, function(data) {
        if(data['text']){
          obj.parent().parent().remove();
        }
        else{
          obj.replaceWith('删除失败.')
        }
      });
    }
  } 
</script>