<%= content_for :ahead do %>
    <link href="/newbackstage/css/menu.css" rel="stylesheet" type="text/css">
    <link href="/newbackstage/css/megsend.css" rel="stylesheet" type="text/css">
    <script type="text/javascript">
        var menujson = {};
        var trigger_click = true;
        $.get('/shop3_menu.json', function(data){
            menujson = data
        })
    </script>
    <script src="/newbackstage/js/menuset.js" type="text/javascript"></script>
    <script src="/newbackstage/js/menu_drag.js" type="text/javascript"></script>
<% end %>
<div id="BG"></div>
<div id="DelDiv">
	<center>这里放置提示信息</center>
	<a onclick="Close2()" class="btn11 w55 mt10 m_auto">确定</a>
</div>
<script>
var sn="F",	//用于子菜单，添加子菜单时此值用subnum确定。
	str,	//用于存放新增/编辑
	delnum; //删除编号
function OpenBG(){
	var top;
    documentHeight=$(document).height();
    windowHeight=$(window).height();
    if(documentHeight<=windowHeight){
      $("#BG").css({"height":windowHeight+"px","display":"block"});
    }else{
      $("#BG").css({"height":documentHeight+"px","display":"block"});
    }
}
function MessageDelDiv(deldivmessage){
	$("#DelDiv center").html(deldivmessage);
	OpenBG();
    $("#DelDiv").fadeIn(600);
}
function Close2(){
	$("#DelDiv").animate({"top":"0px"},400,function(){
		$("#DelDiv,#BG").css("display","none");
	});
}

function Close(ID){
	$("#"+ID).animate({"top":"0px"},400,function(){
		$("#"+ID).removeAttr("style");
		$("#"+ID+",#BG").css("display","none");
		sn="F";
	});
}
function InfoDiv(strs,subnum){
	if(strs==""){
		if(menujson.menu.button.length>=3 ){
			MessageDelDiv("<br/>一级菜单最多只能三个");
			return false;
		}
		if(subnum!=""){
			if(menujson.menu.button[subnum].sub_button.length >=5 ){
				MessageDelDiv("<br/>二级菜单最多只能五个");
				return false;
			}
			sn=subnum;
		}
		str="news";
	}else{
		str="edit";
		if(subnum!=""){
			sn=(subnum.toString()).split(",");
			if((sn.length==1)&&(menujson.menu.button[subnum].sub_button.length!=0)){
				MessageDelDiv("<br/>已有子菜单，无法设置动作");
				return false;
			}
		}
	}
	OpenBG();
	$("#Inputs").val(strs);
    $("#Info").fadeIn(600);
}
function SubMits(){
	var name,index;
	$("#TS").addClass("none");
	if(sn=="F"){
		index=null;
	}else{
		index=sn;
	}
	name = $('#Inputs').val();
	name = name.replace(/^[ ]*|[ ]*$/g,'');
	if(name.length==0){
		$("#TS").removeClass("none").html("输入框内容不能为空");
	}else if(name.length>=8){
		$("#TS").removeClass("none").html("菜单名称不能超过8个汉字");
	}
		
	if(str=="news"){
		$.post("/shop3_menu/add_menu", {index: index, name: name }, function(data){
			menujson = data;
			relist_menu();
			$("#TS").addClass("none");
			$("#Info,#BG").css("display","none");
			sn="F";
		});
	}else if(str=="edit"){
		$.post("/shop3_menu/edit_menu", {index: index, name: name }, function(data){
			menujson = data;
			relist_menu();
			$("#TS").addClass("none");
			$("#Info,#BG").css("display","none");
			sn="F";
		});
	}
}

function MesSubMits(){
	OpenBG();
    $("#Message1").fadeIn(600);
}
function FormMits(){
	$("#Message1").css("display","none");
	var allow_pub = true
	menujson.menu.button.forEach(function(button){
		if(button.sub_button.length > 0){
			button.sub_button.forEach(function(sub_button){
				if(!sub_button.type){
					allow_pub = false;
				}
			});
		}else{
			if(!button.type){
				allow_pub = false;
			}
		}
	});
	if(allow_pub){
		$.post("/shop3_menu/pub", function(data){
			MessageDelDiv("<br/>发布成功");
		})
	}else{
		MessageDelDiv("存在还未设置响应动作的菜单,请检查。");
	}
}
function DelDiv(subnum){
	delnum=(subnum.toString()).split(",");
	OpenBG();
    $("#Del").fadeIn(600);
}
function DelSubMits(){	
	$.post("/shop3_menu/del", {index: delnum}, function(data){
		menujson = data;
		relist_menu();
		$("#Del,#BG").css("display","none");
		delnum="";
	});
}

function View() {
	
}

</script>
<div class="con">
	<div class="title1"><h2 class="f18 l">自定义菜单</h2></div>
	<div class="box15 orange1">编辑：可创建最多 3 个一级菜单，每个一级菜单下可创建最多 5 个二级菜单。编辑中的菜单不会马上被用户看到，请放心调试。</div>
	
	<div id="Del" class="box16">
		<form onsubmit="return false;" method="post">
			<p>温馨提示</p>
			<div class="box16inner">
				<div class="warms">删除确认<br/>删除后该菜单下设置的消息将不会被保存</div>
				<div class="clear1"></div>
				<input type="submit" value="确 认" class="btn22 l mt30" onclick="DelSubMits()"/>
				<input type="button" value="取 消" class="btn22 r mt30" onclick="Close('Del')"/>
			</div>
		</form>
	</div>
	
	<div id="Info" class="box16">
		<form onsubmit="return false;" method="post">
			<p>菜单管理</p>
			<div class="box16inner">
				<p class="mt20 f14">菜单名称不能超过8个汉字：</p>
				<p><input type="text" class="inputs4 mt10 mb15" id="Inputs"></p>
				<div class="clear1"></div>
				<input type="submit" value="确 认" class="btn22 l mt30" onclick="SubMits()"/>
				<input type="button" value="取 消" class="btn22 r mt30" onclick="Close('Info')"/>
			</div>
		</form>
	</div>	

	<div class="inner_container_box side_l menu_setting_area_bd mt30">            
		<div class="inner_side">                
			<div class="bd">                    
				<div class="menu_manage">                        
					<div class="sub_title_bar light">                            
						<h4>菜单管理</h4>
						<div class="btn_wrp" style="float:right;padding-top:5px;">
							<a class="btn btn_default r" id="orderBt" href="javascript:void(0);" style="padding:0px 7px;">排序</a>
							<a class="btn btn_primary r" onclick="InfoDiv('','')" style="padding:0px 7px;">添加</a>
							<a style="display: none;padding:0px 7px;" class="btn btn_primary btn_sorting" id="finishBt" href="javascript:void(0);">完成</a>
							<a style="display: none;padding:0px 7px;" class="btn btn_default btn_sorting" id="cancelBt" href="javascript:void(0);">取消</a>&nbsp;
						</div>
					</div>
					<div id="menuList" class="inner_menu_box with_switch blue ui-sortable ui-sortable-disabled">
						<% @menu && @menu.button.each_with_index do |m, index|%>
							<dl class="inner_menu jsMenu ui-sortable ui-sortable-disabled">
								<dt id="menu_<%= index %>" class="inner_menu_item jslevel1">
									<i class="icon_inner_menu_switch"></i>
									<a class="inner_menu_link" href="javascript:void(0);">
										<strong><%= m['name']%></strong>
									</a>
									<span class="menu_opr">
										<% if m['type'].blank? %>
											<a class="icon14_common add_gray" onclick="InfoDiv('','<%= index %>')" rel='<%= index %>'>添加</a>
										<% end %>
										<a class="icon14_common  edit_gray" onclick="InfoDiv('<%= m['name']%>','<%= index %>')" rel='<%= index %>'>编辑</a>
										<a class="jsDelBt" onclick="DelDiv(<%= index %>)" rel='<%= index %>'>删除</a>
										<a style="display:none" class="icon14_common sort_gray jsOrderBt" href="javascript:void(0);">排序</a>
									</span>
								</dt>
							<% m['sub_button'] && m['sub_button'].each_with_index do |sb, sbi| %>
								<dd id="subMenu_menu_<%= index %>_<%= sbi %>" class="inner_menu_item jslevel2">
									<i class="icon_dot">●</i>
									<a class="inner_menu_link" href="javascript:void(0);"><strong><%= sb['name'] %></strong></a>
									<span class="menu_opr">
										<a class="icon14_common edit_gray" onclick="InfoDiv('<%= sb['name'] %>','<%= "#{index},#{sbi}" %>')" rel='<%= "#{index},#{sbi}" %>'>编辑</a>
										<a  onclick="DelDiv('<%= index %>,<%=sbi%>')" rel='<%= "#{index},#{sbi}" %>'>删除</a>
										<a style="display:none" class="icon14_common sort_gray jsOrderBt" href="javascript:void(0);">排序</a>
									</span>
								</dd>
							<% end%>
							</dl>
						<% end %>
					</div>
				</div>
			</div>
		</div>

		<div class="inner_main">
			<!--<div class="bd">
					<div class="sub_title_bar light">
						<h4>设置动作</h4>
						<div class="btn_wrp">
							<a id="changeBt" class="btn btn_default btn_editing" href="javascript:void(0);" style="display: none;">修改</a>
						</div>
					</div>
					<div id="FirstPlane" class="action_content" style="display: block;">
						<center class="mt200">你可以先添加一个菜单，然后开始为其设置响应动作</center>
					</div>
					
					<div id="index" style="display: none;" class="action_content init">
						<p class="action_tips">请选择订阅者点击菜单后，公众号做出的相应动作</p>
						<a id="sendMsg" href="javascript:void(0);">
							<i class="icon_menu_action send"></i>
							<strong>发送信息</strong>
						</a>
						<a id="goPage" href="javascript:void(0);">
							<i class="icon_menu_action url"></i>
							<strong>跳转到网页</strong>
						</a>
					</div>
					<div id="url" class="action_content url" style="display: none;">
						<form onsubmit="return false;" id="urlForm" action="">
							<p class="action_tips">订阅者点击该子菜单会跳到以下链接</p>
							<div class="frm_control_group">
								<span class="frm_input_box">
									<input type="text" name="urlText" id="urlText" class="frm_input">
								</span>
								<p id="urlFail" style="display: none;" class="frm_msg fail">
									<i>●</i>
									<span style="display: inline;" class="frm_msg_content" for="urlText">请输入正确的URL</span>
								</p>
							</div>
						</form>
						<div class="tool_bar">
							<a id="urlBack" class="btn btn_default" href="javascript:void(0);">返回</a>
							<a id="urlSave" type="submit" class="submit btn btn_primary">保存</a>
						</div>
					</div>
					<div id="view" class="action_content sended" style="display: none;">
						<p class="action_tips">订阅者点击该子菜单会跳到以下链接</p>
						<div id="viewDiv" class="msg_wrp">http://www.dface.cn/torus/index.html</div>
					</div>

					<%= render  'edit_dialog' %>

					<div id="edit" class="action_content send" style="display: none;">
						<p class="action_tips">订阅者点击该子菜单会收到以下消息</p>
						<div id="editDiv" class="msg_sender small"></div>
						<div class="tool_bar">
							<a id="editBack" class="btn btn_default" href="javascript:void(0);">返回</a>
							<a id="editSave" class="btn btn_primary" href="javascript:void(0);">保存</a>
						</div>
					</div>
			</div>-->
		</div>
	</div>
	
	<div><p class="st mt10 gay4 f12">发布<br/>编辑中的菜单不能直接在用户手机上生效，你需要进行发布，发布后24小时内所有的用户都将更新到新的菜单。</p></div>
	<div class="line1 mt20 mb40"></div>
    <div class="w400 m_auto">        
		<a id="viewBt" class="btn22 l">预览</a>
		<a id="pubBt" onClick="MesSubMits()" class="btn22 r">发布</a>
    </div>
</div>




<div id='menu_image_dialog' style='display: none'>
    <div style="z-index:999;width: 960px; margin-left: -480px; margin-top: -314.5px;" class="dialog_wrp media">
        <div class="dialog">
            <div class="dialog_hd">
                <h3>选择图片</h3>
                <a class="icon16_opr closed pop_closed" onclick="return false" href="javascript:;">关闭</a>
            </div>
            <div class="dialog_bd">
                <div class="dialog_media_container ">
                    <ul class="dialog_media_list js_media_list">
                        <% session_shop.shop_photo.each do |photo| %>
                            <li class="media_item">
                              
                                <div class="media_content" data-type="2" >
                                    <label class="media_name frm_radio_label" for="checkbox3">
                                        <input type="radio" value="<%= photo.id %>" name='image_val' >
                                    </label>
                                    <a class="media_img" target="_blank">
                                        <img src="<%= photo.img.url(:t2)%>" class="wxmImg Zoomin">
                                    </a>
                                    <p class="media_size" style='top: 30px;'><%= photo.desc.truncate(20) %></p>
                                </div>
                            </li>
                        <% end %>
                    </ul>
                </div>
            </div>
            <div class="dialog_ft">
                <span class="btn btn_primary btn_input js_btn_p"><button data-index="0" class="js_btn" id='menu_img_add'>确定</button></span>
                <span class="btn btn_default btn_input js_btn_p"><button data-index="1" class="js_btn" id='menu_img_cancel'>取消</button></span>
            </div>
        </div>
    </div>

    <div class="mask" style="z-index:998">
        <iframe frameborder="0" src="about:blank" style="filter:progid:DXImageTransform.Microsoft.Alpha(opacity:0);position:absolute;top:0px;left:0px;width:100%;height:100%;"></iframe>
    </div>

</div>

<div id='menu_faq_dialog' style='display: none'>
    <div style="z-index:999;width: 960px; margin-left: -480px; margin-top: -314.5px;" class="dialog_wrp media">
        <div class="dialog">
            <div class="dialog_hd">
                <h3>选择问答</h3>
                <a class="icon16_opr closed pop_closed" onclick="return false" href="javascript:;">关闭</a>
            </div>
            <div class="dialog_bd">
                <div class="dialog_media_container ">
                    <ul class="dialog_media_list js_media_list">
                        <% session_shop.faqs.each do |faq| %>
                            <li class="media_item">
                              
                                <div class="media_content" data-type="2" >
                                    <label class="media_name frm_radio_label" for="checkbox3">
                                        <input type="radio" value="<%= faq.id %>" name='image_val' >
                                    </label>
                                    <a class="media_img" target="_blank">
                                        <span><%= faq.od %></span>
                                    </a>
                                    <p class="media_size" style='top: 30px;'><%= faq.title.truncate(20) %></p>
                                </div>
                            </li>
                        <% end %>
                    </ul>
                </div>
            </div>
            <div class="dialog_ft">
                <span class="btn btn_primary btn_input js_btn_p"><button data-index="0" class="js_btn" id='menu_faq_add'>确定</button></span>
                <span class="btn btn_default btn_input js_btn_p"><button data-index="1" class="js_btn" id='menu_faq_cancel'>取消</button></span>
            </div>
        </div>
    </div>

    <div class="mask" style="z-index:998">
        <iframe frameborder="0" src="about:blank" style="filter:progid:DXImageTransform.Microsoft.Alpha(opacity:0);position:absolute;top:0px;left:0px;width:100%;height:100%;"></iframe>
    </div>

</div>

<div id='mobile_review' style='display: none'>
    <%= hidden_field_tag :logo_url, @logo, :id => 'mobile_logo' %>
    <div id="mobileDiv" class="mobile_preview" style="display: block;z-index:999 ">    
        <div class="mobile_preview_hd">        
            <strong class="nickname"><%= session_shop.name %></strong>    
        </div>    
        <div class="mobile_preview_bd">        
            <ul class="show_list" id="viewShow">                    
            </ul>    
        </div>    
        <div class="mobile_preview_ft">        
            <ul id="viewList" class="pre_menu_list">
            </ul>    
        </div>    
        <a id="viewClose" class="mobile_preview_closed" href="javascript:void(0);">关闭</a>
    </div>
    <div class="mask" style="z-index:998">
        <iframe frameborder="0" src="about:blank" style="filter:progid:DXImageTransform.Microsoft.Alpha(opacity:0);position:absolute;top:0px;left:0px;width:100%;height:100%;"></iframe>
    </div>
</div>


<!-- ++++++++++++++++++发布+++++++++++++++++++ -->
<div id="Message1" class="box16">
	<form onsubmit="return false;" method="post">
		<p>温馨提示</p>
		<div class="box16inner w400">
			<div class="warms">发布确认<br/><span class="f13 orange1">本次发布将在24小时内对所有用户生效。确认发布？</span></div>
			<div class="clear1"></div>
			<input type="submit" value="确 认" class="btn22 l mt30 ml30" onclick="FormMits()"/>
			<input type="button" value="取 消" class="btn22 r mt30 mr30" onclick="Close('Message1')"/>
		</div>
	</form>
</div>
<!-- ++++++++++++++++++发布+++++++++++++++++++ -->